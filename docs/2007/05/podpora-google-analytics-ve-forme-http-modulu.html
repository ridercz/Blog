<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Podpora Google Analytics ve formě HTTP modulu | ALTAIR.blog</title>
    <meta name="viewport" content="width=device-width,minimum-scale=1,initial-scale=1" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <meta http-equiv="Content-Language" content="cs-CZ" />
    <link rel="canonical" href="https://www.altair.blog/2007/05/podpora-google-analytics-ve-forme-http-modulu" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/firacode/6.2.0/fira_code.min.css" integrity="sha512-MbysAYimH1hH2xYzkkMHB6MqxBqfP0megxsCLknbYqHVwXTCg9IqHbk+ZP/vnhO8UEW6PaXAkKe2vQ+SWACxxA==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <link rel="stylesheet" type="text/css" href="/content/styles.min.css?sha=86D6BE2BECADA8998ACB7999F797DEF1103C76B2" />
    <link rel="stylesheet" type="text/css" href="/content/fa-6.5.1/css/all.min.css" />
    <link rel="alternate" type="application/rss+xml" href="https://www.altair.blog/feed.rss" title="RSS (všechny články)" />
    <link rel="alternate" type="application/rss+xml" href="https://www.altair.blog/feed-internal.rss" title="RSS (pouze místní články)" />
    <link rel="alternate" type="application/rss+xml" href="https://www.altair.blog/feed-external.rss" title="RSS (pouze odkazy)" />
    <link rel="shortcut icon" href="https://www.altair.blog/favicon.ico" />
    <link rel="icon" href="https://www.altair.blog/favicon.ico" />
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:site" content="@ridercz" />
    <meta name="twitter:title" content="Podpora Google Analytics ve formě HTTP modulu" />
    <meta name="twitter:description" content="Zhruba jednou do roka se na mne obrátí jistá nešťastná duše z Microsoftu, hnána touhou naplniti výkazy a formuláře přehršlí čísel. Klade dotazy typu &quot;kolik lidí chodí na ASPNET.CZ&quot; a nedá pokoj, dokud nedostane odpověď. Několik let jsem k řešení tohoto problému úspěšně používal metodu Monte Carlo, pak jsem přešel na Google Analytics. Nyní jsem si k přidávání měřícího kódu napsal HTTP modul,na němž jest demonstrovati celou řadu užitečných technik." />
    <meta name="twitter:image" content="https://www.altair.blog/content/images/preview-1200.jpg" />
    <meta property="article:published_time" content="2007-05-08T05:01:33.867+02:00" />
    <meta property="og:type" content="article" />
    <meta property="og:site_name" content="ALTAIR.blog" />
    <meta name="author" content="Michal Altair Valášek" />
    <meta name="title" property="og:title" content="Podpora Google Analytics ve formě HTTP modulu" />
    <meta name="description" property="og:description" content="Zhruba jednou do roka se na mne obrátí jistá nešťastná duše z Microsoftu, hnána touhou naplniti výkazy a formuláře přehršlí čísel. Klade dotazy typu &quot;kolik lidí chodí na ASPNET.CZ&quot; a nedá pokoj, dokud nedostane odpověď. Několik let jsem k řešení tohoto problému úspěšně používal metodu Monte Carlo, pak jsem přešel na Google Analytics. Nyní jsem si k přidávání měřícího kódu napsal HTTP modul,na němž jest demonstrovati celou řadu užitečných technik." />
    <meta name="image" property="og:image" content="https://www.altair.blog/content/images/preview-1200.jpg" />
    <meta property="og:locale" content="cs_CZ" />
    <meta property="og:url" content="https://www.altair.blog/2007/05/podpora-google-analytics-ve-forme-http-modulu" />
    <script>
      (function(f, a, t, h, o, m){
        a[h]=a[h]||function(){
          (a[h].q=a[h].q||[]).push(arguments)
        };
        o=f.createElement('script'),
        m=f.getElementsByTagName('script')[0];
        o.async=1; o.src=t; o.id='fathom-script';
        m.parentNode.insertBefore(o,m)
      })(document, window, '//stats.altair.blog/tracker.js', 'fathom');
      fathom('set', 'siteId', 'OBOTR');
      fathom('trackPageview');
    </script>
    <script src="/content/scripts/autocorrect.js?sha=3D24FB150C3151FFF3B9BFCA112E1A8B2F32B377" defer="defer" onload="typo.runAutoCorrector({number: false})">//</script>
    <meta name="robots" content="index, follow" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.4.0/styles/default.min.css" integrity="sha512-hasIneQUHlh06VNBe7f6ZcHmeRTLIaQWFd43YriJ0UND19bvYRauxthDg8E4eVNPm9bRUhr5JGeqH7FRFXQu5g==" crossorigin="anonymous" referrerpolicy="no-referrer" />
  </head>
  <body>
    <header>
      <div>
        <a href="/">
          <img src="/content/images/logo_onblack.svg" alt="altair.blog" style="max-height:100px;max-width:80%" />
        </a>
      </div>
    </header>
    <nav>
      <ul>
        <li>
          <a href="https://www.rider.cz/" title="Autor: Michal Altair Valášek">
            <i class="fal fa-fw fa-user"> </i>
          </a>
        </li>
        <li>
          <a href="/archive" title="Archiv článků">
            <i class="fal fa-fw fa-archive"> </i>
          </a>
        </li>
        <li>
          <a href="/categories" title="Rubriky">
            <i class="fal fa-fw fa-tags"> </i>
          </a>
        </li>
        <li>
          <a href="/serials" title="Seriály">
            <i class="fal fa-fw fa-list-alt"> </i>
          </a>
        </li>
        <li>
          <a href="/search" title="Vyhledávání">
            <i class="fal fa-fw fa-search"> </i>
          </a>
        </li>
        <li>
          <a href="https://www.rider.cz/#contact" title="Kontakt">
            <i class="fal fa-fw fa-envelope"> </i>
          </a>
        </li>
        <li>
          <a href="https://facebook.com/rider.cz" title="Facebook">
            <i class="fab fa-fw fa-facebook"> </i>
          </a>
        </li>
        <li>
          <a href="https://twitter.com/ridercz" title="Twitter">
            <i class="fab fa-twitter"> </i>
          </a>
        </li>
        <li>
          <a href="https://github.com/ridercz" title="Github">
            <i class="fab fa-fw fa-github"> </i>
          </a>
        </li>
        <li>
          <a href="https://ask.fm/ridercz" title="Ask.fm">
            <i class="fal fa-fw fa-question"> </i>
          </a>
        </li>
      </ul>
    </nav>
    <main>
      <h1>Podpora Google Analytics ve formě HTTP modulu</h1>
      <aside class="article-info">
        <ul class="categories">
          <li>
            <a href="/categories/it" title="Rubrika">
              <i class="fal fa-tag"> </i>IT</a>
          </li>
        </ul>
        <div title="Autor">
          <a href="https://www.rider.cz/">Michal Altair Valášek </a>
          <i class="fal fa-fw fa-user">​</i>
        </div>
        <div title="Datum vydání">
          <time datetime="2007-05-08T05:01:33.867+02:00">8. května 2007 <i class="fal fa-fw fa-calendar-lines">​</i></time>
        </div>
      </aside>
      <section class="article-text">
        <p>Zhruba jednou do roka se na mne obrátí jistá nešťastná duše z Microsoftu, hnána touhou naplniti výkazy a formuláře přehršlí čísel. Klade dotazy typu "kolik lidí chodí na ASPNET.CZ" a nedá mně pokoj, dokud nedostane odpověď. Několik let jsem k řešení tohoto problému úspěšně používal metodu Monte Carlo, pak jsem přešel na Google Analytics. Výsledek je zhruba stejný, ale líp to vypadá ;-)</p><p>Měřící kód vkládám do stránek dynamicky a nyní jsem celou záležitost vyřešil pomocí HTTP modulu. Na tomto postupu lze ukázat celou řadu užitečných technik, najmě pak:</p><ul><li>Tvorbu a použití HTTP modulů všeobecně. </li><li>Použití události PreRequestHandlerExecute k manipulaci se stránkou. </li><li>Generování (a registrování) klientských skriptů z ASP.NET. </li><li>Vytváření vlastních kongifuračních sekcí</li></ul><h2>Jak funguje Google Analytics a proč použít HTTP modul</h2><p>Pokud chcete používat pro měření návštěvnosti svého webu <a href="http://www.google.com/analytics/">Google Analytics</a>, stačí vám vložit do stránky dva kousky JavaScriptu, Google se postará o zbytek. </p><pre><span style="COLOR: #0000ff">&lt;</span><span style="COLOR: #800000">script</span> <span style="COLOR: #ff0000">src</span>=<span style="COLOR: #0000ff">"http://www.google-analytics.com/urchin.js"</span> <span style="COLOR: #ff0000">type</span>=<span style="COLOR: #0000ff">"text/javascript"</span><span style="COLOR: #0000ff">></span><span style="COLOR: #0000ff">&lt;/</span><span style="COLOR: #800000">script</span><span style="COLOR: #0000ff">></span>
<span style="COLOR: #0000ff">&lt;</span><span style="COLOR: #800000">script</span> <span style="COLOR: #ff0000">type</span>=<span style="COLOR: #0000ff">"text/javascript"</span><span style="COLOR: #0000ff">></span>
<span style="COLOR: #008000">&lt;!--_uacct = "UA-172431-1";urchinTracker();// --></span>
<span style="COLOR: #0000ff">&lt;/</span><span style="COLOR: #800000">script</span><span style="COLOR: #0000ff">></span></pre><p>Proč tedy takovou věc řešit složitě pomocí HTTP modulu programově, místo abychom napsali dané do stránky "natvrdo"? Důvodů je hned několik:</p><p>Kód je jiný pro běžné stránky (HTTP) a jiný pro šifrované stránky (HTTPS). Pokud vaše aplikace využívá obé a dynamicky se mezi těmito režimy přepíná podle potřeby (jako např. web <a href="http://akce.altairis.cz/">akce.altairis.cz</a>), je nutné kód generovat dynamicky, podle použité přístupové metody.</p><p>Pokud má vaše aplikace být univerzální a na Internetu žije v několika exemplářích, je dobré mít možnost určovat použité měřící ID (či samu skutečnost, zda se má měření provádět) pomocí konfiguračního souboru. No a konečně, pokud takových aplikací máte povícero, jest obvykle žádoucí zajistit, aby jejich chování bylo stejné.</p><p>Stejný úkol lze řešit např. pomocí MasterPages nebo pomocí vlastní base class pro stránky. Mnou navrhované řešení má nicméně tu výhodu, že je použitelné pro jakoukoliv aplikaci, a to aniž by bylo nutno do aplikace samé jakkoliv zasahovat. Modul lze přiřadit čistě konfiguračně.</p><h2>Vytvoření vlastní konfigurační sekce</h2><p>Konfigurace tohoto modulu je jednoduchá, vyžaduje toliko jediný parametr, kterým je identifikátor pro měření - v mém případě <em>UA-172431-1</em>. Nabízející se možností je vytvořit v sekci <em>appSettings</em> nějak vhodně pojmenovaný klíč a ten pak použít. Tento přístup ovšem nepokládám v případě univerzálních komponent za příliš šťastný. </p><p>Nenabízí totiž žádnou záruku jedinečnosti - appSettings je sekce určená pro nastavení vlastní aplikace, ne univerzálních komponent. Neobsahuje tedy žádné nástroje pro zajištění jedinečnosti názvu konfigurační proměnné. Pokud ji pojmenujeme třeba "<em>StatId</em>", nikde není řečeno, že podobný nápad nebude mít někdo jiný, s jinou komponentou.</p><p>Postup s <em>appSettings</em> se také hodí toliko pro menší počet hodnot, které nemají žádnou zásadnější strukturu. Pokud vaše aplikace vyžaduje složitější konfiguraci, jest záhodno napsat si vlastní konfigurační systém. Tento úkol byl v ASP.NET verze 1.x dosti nevděčný, leč verze 2.0 přinesla programátorům úlevu i v tomto směru.</p><p>Pojďme se tedy podívat na to, jak bude vypadat odpovídající část konfiguračního souboru <em>web.config</em>:</p><div style="FONT-SIZE: 11pt; BACKGROUND: white; COLOR: black; FONT-FAMILY: consolas, courier new, monospace"><p style="MARGIN: 0px"><span style="COLOR: #0000ff">&lt;?</span><span style="COLOR: #a31515">xml</span><span style="COLOR: #0000ff"> </span><span style="COLOR: #ff0000">version</span><span style="COLOR: #0000ff">=</span>"<span style="COLOR: #0000ff">1.0</span>"<span style="COLOR: #0000ff">?></span></p><p style="MARGIN: 0px"><span style="COLOR: #0000ff">&lt;</span><span style="COLOR: #a31515">configuration</span><span style="COLOR: #0000ff">></span></p><p style="MARGIN: 0px"><span style="COLOR: #0000ff">  &lt;</span><span style="COLOR: #a31515">configSections</span><span style="COLOR: #0000ff">></span></p><p style="MARGIN: 0px"><span style="COLOR: #0000ff">    &lt;</span><span style="COLOR: #a31515">sectionGroup</span><span style="COLOR: #0000ff"> </span><span style="COLOR: #ff0000">name</span><span style="COLOR: #0000ff">=</span>"<span style="COLOR: #0000ff">altairis.web</span>"<span style="COLOR: #0000ff">></span></p><p style="MARGIN: 0px"><span style="COLOR: #0000ff">      &lt;</span><span style="COLOR: #a31515">section</span><span style="COLOR: #0000ff"> </span><span style="COLOR: #ff0000">name</span><span style="COLOR: #0000ff">=</span>"<span style="COLOR: #0000ff">management</span>"<span style="COLOR: #0000ff"> </span><span style="COLOR: #ff0000">type</span><span style="COLOR: #0000ff">=</span>"<span style="COLOR: #0000ff">Altairis.Web.Configuration.ManagementSection, Altairis.Web</span>"<span style="COLOR: #0000ff"> /></span></p><p style="MARGIN: 0px"><span style="COLOR: #0000ff">    &lt;/</span><span style="COLOR: #a31515">sectionGroup</span><span style="COLOR: #0000ff">></span></p><p style="MARGIN: 0px"><span style="COLOR: #0000ff">  &lt;/</span><span style="COLOR: #a31515">configSections</span><span style="COLOR: #0000ff">></span></p><p style="MARGIN: 0px"><span style="COLOR: #0000ff">  &lt;</span><span style="COLOR: #a31515">altairis.web</span><span style="COLOR: #0000ff">></span></p><p style="MARGIN: 0px"><span style="COLOR: #0000ff">    &lt;</span><span style="COLOR: #a31515">management</span><span style="COLOR: #0000ff">></span></p><p style="MARGIN: 0px"><span style="COLOR: #0000ff">      &lt;</span><span style="COLOR: #a31515">googleAnalytics</span><span style="COLOR: #0000ff"> </span><span style="COLOR: #ff0000">trackId</span><span style="COLOR: #0000ff">=</span>"<span style="COLOR: #0000ff">UA-172431-1</span>"<span style="COLOR: #0000ff"> /> </span></p><p style="MARGIN: 0px"><span style="COLOR: #0000ff">    &lt;/</span><span style="COLOR: #a31515">management</span><span style="COLOR: #0000ff">></span></p><p style="MARGIN: 0px"><span style="COLOR: #0000ff">  &lt;/</span><span style="COLOR: #a31515">altairis.web</span><span style="COLOR: #0000ff">></span></p><p style="MARGIN: 0px"><span style="COLOR: #0000ff">&lt;/</span><span style="COLOR: #a31515">configuration</span><span style="COLOR: #0000ff">></span></p></div><p>Celou záležitost by samozřejmě šlo vyřešit i s mnohem jednodušeji a mnou navržený postup se zdá býti možná až příliš krkolomný. Prvním důvodem jest, že tento příklad je toliko malým výsekem z obsáhlejší knihovny, oplývající celou řadou užitečných funkcí, kdežtě jest složitější konfigurace nezbytná. Druhým důvodem jsou jako obvykle mé pohnutky didaktické, neb chci laskavé čtenáře obeznámit se širokou paletou možností, jimiž .NET Framework v této věci oplývá.</p><h3>Configuration Section Group</h3><p>Na samém vrcholu konfigurační struktury dlí skupina konfiguračních sekcí. V našem případě se jedná o element <em>altairis.web</em>. Cílem section groups je sdružovati jednotlivé elementy do logických skupin. Obvykle se pokládá za vhodné, aby struktura konfiguračního souboru alespoň částečně souzněla s logickou strukturou tříd a namespaces konfigurované knihovny.</p><p>Section Group je tedy vyšší organizační jednotka, kterou ve své architektuře použít můžete, ale nemusíte. Sama neobsahuje žádné konfigurační údaje přímo, ale je obálkou pro konfigurační sekce, které podrobněji pojednáme dále.</p><p>Doporučuje se (a třídy v .NET Frameworku vestavěné tuto zásadu dodržují), aby název section group odpovídal názvu namespace, který je konfigurován, ovšem malými písmeny. V případě knihoven se pak doporučuje, aby namespace obsahoval název firmy nebo jiný jednoznačný identifikátor. Moje knihovna webových utilit se jmenuje <em>Altairis.Web</em> a proto se i section group jmenuje <em>altairis.web</em>.</p><p>Skupinu konfiguračních sekcí jest nutno zaregistrovati na začátku souboru, v elementu <em>configSections</em>. Jako jediná zde zmiňovaná entita nemusí mít (ač může) svůj protějšek v podobě třídy, pomocí které by bylo možno s obsahem pracovat. Prostá registrace postačí. V případě extrémně složitých konfiguračních schémat lze do sebe section groups dokonce i zanořovat, ale nedoporučuji tohoto postupu využívat příliš často.</p><h3>Configuration Section</h3><p>Konfigurační sekce je základem celého systému. V našem případě se jedná o element s názvem <em>management</em>. Je také jedinou povinnou součástí - jak elementy nadřazené (section groups) tak podřízené (elements) použít dle náročnosti můžete, ale nemusíte. Sekce sama je ale základem a musí být přítomna vždy.</p><p>I sekci je nutné nejprve zaregistrovat a tentokráte je třeba i vytvořit třídu, která bude v kódu sekci reprezentovat. Odkaz na ni pak uvedete jako hodnotu atributu <em>type</em>. V mém případě se jedná o třídu <em>Altairis.Web.Configuration.ManagementSection</em>, která se nachází v assembly <em>Altairis.Web.dll</em>. Je dobrým zvykem pojmenovávat tyto třídy tak, že jejich název odpovídá názvu elementu a je na konci doplněn slovem "Section".</p><p>Při psaní vlastních sekcí v .NET 1.x vám nezbylo, než ve své třídě implementovat rozhraní <em>IConfigurationSection</em> a v podstatě celou funkčnost si napsat sami. V případě .NET 2.0 je situace výrazně jednodušší: v drtivě většině případů se obejdete bez "skutečného" programování, stačí nadefinovat odpovídající vlastnosti a odekorovat je vhodnými atributy. Sám .NET se postará o to, aby byly hodnoty správně načteny atd.</p><p>Zdrojový kód třídy <em>ManagementSection</em> vypadá takto:</p><div style="FONT-SIZE: 11pt; BACKGROUND: white; COLOR: black; FONT-FAMILY: consolas, courier new, monospace"><p style="MARGIN: 0px"><span style="COLOR: #0000ff">using</span> System;</p><p style="MARGIN: 0px"><span style="COLOR: #0000ff">using</span> System.Configuration;</p><p style="MARGIN: 0px"> </p><p style="MARGIN: 0px"><span style="COLOR: #0000ff">namespace</span> Altairis.Web.Configuration {</p><p style="MARGIN: 0px"> </p><p style="MARGIN: 0px">    <span style="COLOR: #0000ff">public</span> <span style="COLOR: #0000ff">class</span> <span style="COLOR: #2b91af">ManagementSection</span> : <span style="COLOR: #2b91af">ConfigurationSection</span> {</p><p style="MARGIN: 0px"> </p><p style="MARGIN: 0px">        [<span style="COLOR: #2b91af">ConfigurationProperty</span>(<span style="COLOR: #a31515">"googleAnalytics"</span>)]</p><p style="MARGIN: 0px">        <span style="COLOR: #0000ff">public</span> <span style="COLOR: #2b91af">GoogleAnalyticsElement</span> GoogleAnalytics {</p><p style="MARGIN: 0px">            <span style="COLOR: #0000ff">get</span> { <span style="COLOR: #0000ff">return</span> (<span style="COLOR: #2b91af">GoogleAnalyticsElement</span>)<span style="COLOR: #0000ff">this</span>[<span style="COLOR: #a31515">"googleAnalytics"</span>]; }</p><p style="MARGIN: 0px">            <span style="COLOR: #0000ff">set</span> { <span style="COLOR: #0000ff">this</span>[<span style="COLOR: #a31515">"googleAnalytics"</span>] = <span style="COLOR: #0000ff">value</span>; }</p><p style="MARGIN: 0px">        }  </p><p style="MARGIN: 0px"> </p><p style="MARGIN: 0px">    }</p><p style="MARGIN: 0px"> </p><p style="MARGIN: 0px">}</p></div><p>Třída sama je poděděna od base class <em>System.Configuration.ConfigurationSection</em>. Lze v ní vytvářet vlastnosti, které odpovídají jednotlivým vnořeným elementům, případně přímo atributům. Já jsem zde vytvořil jedinou vlastnost, která se nazývá <em>GoogleAnalytics</em> a vrací třídu typu <em>GoogleAnalyticsElement</em> (bude definována dále). Tato vlastnost je odekorována parametrem <em>ConfigurationProperty</em>, jehož konstruktor obsahuje specifikaci názvu elementu, který bude použit k vytvoření odpovídající třídy. </p><p>Opět se držím zvyklostí přítomných v .NETu a pro pojmenovávání víceslovných elementů používám <em>camelCase</em>. Proto se tedy vnořený element jmenuje <em>googleAnalytics</em>, ačkoliv technicky možné by byly i varianty jako <em>GoogleAnalytics</em> nebo <em>Google_Analytics</em>.</p><p>Sekce může obsahovat přímo konfigurační atributy s hodnotami (zapisují se stejně jako v případě elementu, viz níže) a nebo může obsahovat ještě další elementy.</p><h3>Configuration Element</h3><p>Nejnižší organizační složkou je element. Ten se nemusí zvlášť registrovat v prologu web.configu, stačí aby na něj bylo odkázáno ze sekce. Element může obsahovat buďto atributy s vlastními hodnotami a nebo další elementy.</p><p>V programovém světě je protějškem elementu třída poděděná od base class pojmenované vcelku logicky <em>System.Configuration.ConfigurationElement</em>. Pojmenování třídy samé obvykle vychází z názvu elementu a na konec se přidává slovo "Element", podobně jako u sekcí. Třída GoogleAnalyticsElement vypadá takto:</p><div style="FONT-SIZE: 11pt; BACKGROUND: white; COLOR: black; FONT-FAMILY: consolas, courier new, monospace"><p style="MARGIN: 0px"><span style="COLOR: #0000ff">using</span> System;</p><p style="MARGIN: 0px"><span style="COLOR: #0000ff">using</span> System.Configuration;</p><p style="MARGIN: 0px"> </p><p style="MARGIN: 0px"><span style="COLOR: #0000ff">namespace</span> Altairis.Web.Configuration {</p><p style="MARGIN: 0px">    <span style="COLOR: #0000ff">public</span> <span style="COLOR: #0000ff">class</span> <span style="COLOR: #2b91af">GoogleAnalyticsElement</span> : <span style="COLOR: #2b91af">ConfigurationElement</span>  {</p><p style="MARGIN: 0px"> </p><p style="MARGIN: 0px">        [<span style="COLOR: #2b91af">ConfigurationProperty</span>(<span style="COLOR: #a31515">"trackId"</span>, IsRequired = <span style="COLOR: #0000ff">false</span>, DefaultValue = <span style="COLOR: #a31515">""</span>)]</p><p style="MARGIN: 0px">        <span style="COLOR: #0000ff">public</span> <span style="COLOR: #0000ff">string</span> TrackId {</p><p style="MARGIN: 0px">            <span style="COLOR: #0000ff">get</span> { <span style="COLOR: #0000ff">return</span> (<span style="COLOR: #0000ff">string</span>)<span style="COLOR: #0000ff">this</span>[<span style="COLOR: #a31515">"trackId"</span>]; }</p><p style="MARGIN: 0px">            <span style="COLOR: #0000ff">set</span> { <span style="COLOR: #0000ff">this</span>[<span style="COLOR: #a31515">"trackId"</span>] = <span style="COLOR: #0000ff">value</span>; }</p><p style="MARGIN: 0px">        }</p><p style="MARGIN: 0px"> </p><p style="MARGIN: 0px">    }</p><p style="MARGIN: 0px">}</p></div><p>Vlastnosti v tomto případě odpovídají konkrétním atributům, přičemž lze definovat i celou řadu dalších pomocných argumentů, jako například zda je daná položka povinná, jakou má výchozí hodnotu a podobně. Vlastnosti mohou být (a měly by být, jedná se o hlavní výhodu) strongly typed, k přetypování dojde automaticky.</p><h3>Využití konfigurační sekce</h3><p>Využití konfigurační sekce je jednoduché. Stačí zavolat metodu <em>System.Configuration.ConfigurationManager.GetSection</em> a výsledek odpovídajícím způsobem přetypovat. Poté je možno pomocí strongly-typed tříd přistupovat ke konfiguračním hodnotám.</p><p>Námi vytvořenou hodnotu tedy načteme následovně:</p><div style="FONT-SIZE: 11pt; BACKGROUND: white; COLOR: black; FONT-FAMILY: consolas, courier new, monospace"><p style="MARGIN: 0px"><span style="COLOR: #008000">// using System.Configuration</span></p><p style="MARGIN: 0px"><span style="COLOR: #008000">// using Altairis.Web.Configuration</span></p><p style="MARGIN: 0px"><span style="COLOR: #2b91af">ManagementSection</span> mgmt = <span style="COLOR: #2b91af">ConfigurationManager</span>.GetSection(<span style="COLOR: #a31515">"altairis.web/management"</span>) <span style="COLOR: #0000ff">as</span> <span style="COLOR: #2b91af">ManagementSection</span>;</p><p style="MARGIN: 0px"><span style="COLOR: #0000ff">string</span> trackId = mgmt.GoogleAnalytics.TrackId;</p></div><h2>Vytvoření HTTP modulu</h2><p>Obecně jsem zde o HTTP modulech již psal. Pro osvěžení paměti mohu doporučit následující články:</p><ul><li><a href="https://www.aspnet.cz/Articles/10-pohled-do-hlubin-webserverovy-duse-aneb-jak-funguji-http-moduly-a-handlery.aspx">Pohled do hlubin webserverovy duše (aneb jak fungují HTTP moduly a handlery)</a> </li><li><a href="https://www.aspnet.cz/Articles/84-modul-pro-basic-autentizaci-v-asp-net.aspx">Modul pro 'basic' autentizaci v ASP.NET</a> </li><li><a href="https://www.aspnet.cz/Articles/13-http-moduly-prakticky.aspx">HTTP moduly prakticky</a></li></ul><p>V tomto konkrétním případě využívám události <em>PreRequestHandlerExecute</em>. Tato událost nastane těsně před tím, než je daný HTTP požadavek předán ke zpracování věcně a místně příslušnému HTTP handleru. Ale, a to je pro nás důležité, až poté, co je vytvořena instance třídy, která je oním HTTP handlerem a tuto třídu potom máme k dispozici ve vlastnosti <em>Handler</em> aktuálního <em>HttpContext</em>u.</p><p>V kódu tohoto event handleru tedy můžeme již jaksi v předstihu volat metody stránky, případně se programově vázat na její události. Patřičný zdrojový kód vypadá následovně:</p><div style="FONT-SIZE: 11pt; BACKGROUND: white; COLOR: black; FONT-FAMILY: consolas, courier new, monospace"><p style="MARGIN: 0px"><span style="COLOR: #0000ff">using</span> System;</p><p style="MARGIN: 0px"><span style="COLOR: #0000ff">using</span> System.Web;</p><p style="MARGIN: 0px"><span style="COLOR: #0000ff">using</span> System.Configuration;</p><p style="MARGIN: 0px"><span style="COLOR: #0000ff">using</span> Altairis.Web.Configuration;</p><p style="MARGIN: 0px"> </p><p style="MARGIN: 0px"><span style="COLOR: #0000ff">namespace</span> Altairis.Web.Management {</p><p style="MARGIN: 0px">    <span style="COLOR: #0000ff">public</span> <span style="COLOR: #0000ff">class</span> <span style="COLOR: #2b91af">GoogleAnalytics</span> : <span style="COLOR: #2b91af">IHttpModule</span> {</p><p style="MARGIN: 0px"> </p><p style="MARGIN: 0px">        <span style="COLOR: #0000ff">private</span> <span style="COLOR: #0000ff">string</span> trackId;</p><p style="MARGIN: 0px"> </p><p style="MARGIN: 0px">        <span style="COLOR: #0000ff">public</span> <span style="COLOR: #0000ff">void</span> Dispose() {</p><p style="MARGIN: 0px">            <span style="COLOR: #008000">// NOOP</span></p><p style="MARGIN: 0px">        }</p><p style="MARGIN: 0px"> </p><p style="MARGIN: 0px">        <span style="COLOR: #0000ff">public</span> <span style="COLOR: #0000ff">void</span> Init(<span style="COLOR: #2b91af">HttpApplication</span> context) {</p><p style="MARGIN: 0px">            <span style="COLOR: #2b91af">ManagementSection</span> mgmt = <span style="COLOR: #2b91af">ConfigurationManager</span>.GetSection(<span style="COLOR: #a31515">"altairis.web/management"</span>) <span style="COLOR: #0000ff">as</span> <span style="COLOR: #2b91af">ManagementSection</span>;</p><p style="MARGIN: 0px">            <span style="COLOR: #0000ff">this</span>.trackId = mgmt.GoogleAnalytics.TrackId;</p><p style="MARGIN: 0px">            <span style="COLOR: #0000ff">if</span> (!<span style="COLOR: #0000ff">string</span>.IsNullOrEmpty(<span style="COLOR: #0000ff">this</span>.trackId)) context.PreRequestHandlerExecute += <span style="COLOR: #0000ff">new</span> <span style="COLOR: #2b91af">EventHandler</span>(context_PreRequestHandlerExecute);</p><p style="MARGIN: 0px">        }</p><p style="MARGIN: 0px"> </p><p style="MARGIN: 0px">        <span style="COLOR: #0000ff">void</span> context_PreRequestHandlerExecute(<span style="COLOR: #0000ff">object</span> sender, <span style="COLOR: #2b91af">EventArgs</span> e) {</p><p style="MARGIN: 0px">            System.Web.UI.<span style="COLOR: #2b91af">Page</span> page = System.Web.<span style="COLOR: #2b91af">HttpContext</span>.Current.Handler <span style="COLOR: #0000ff">as</span> System.Web.UI.<span style="COLOR: #2b91af">Page</span>;</p><p style="MARGIN: 0px">            <span style="COLOR: #0000ff">if</span> (page == <span style="COLOR: #0000ff">null</span>) <span style="COLOR: #0000ff">return</span>; <span style="COLOR: #008000">// handler is not web form</span></p><p style="MARGIN: 0px"> </p><p style="MARGIN: 0px">            <span style="COLOR: #0000ff">if</span> (!page.ClientScript.IsClientScriptBlockRegistered(<span style="COLOR: #a31515">"ga_common"</span>)) {</p><p style="MARGIN: 0px">                <span style="COLOR: #0000ff">if</span> (System.Web.<span style="COLOR: #2b91af">HttpContext</span>.Current.Request.IsSecureConnection) {</p><p style="MARGIN: 0px">                    page.ClientScript.RegisterClientScriptInclude(<span style="COLOR: #a31515">"ga_common"</span>, <span style="COLOR: #a31515">"https://ssl.google-analytics.com/urchin.js"</span>);</p><p style="MARGIN: 0px">                }</p><p style="MARGIN: 0px">                <span style="COLOR: #0000ff">else</span> {</p><p style="MARGIN: 0px">                    page.ClientScript.RegisterClientScriptInclude(<span style="COLOR: #a31515">"ga_common"</span>, <span style="COLOR: #a31515">"http://www.google-analytics.com/urchin.js"</span>);</p><p style="MARGIN: 0px">                }</p><p style="MARGIN: 0px">            }</p><p style="MARGIN: 0px">            <span style="COLOR: #0000ff">if</span> (!page.ClientScript.IsStartupScriptRegistered(<span style="COLOR: #a31515">"ga_startup"</span>)) {</p><p style="MARGIN: 0px">                page.ClientScript.RegisterStartupScript(page.GetType(), <span style="COLOR: #a31515">"ga_startup"</span>, <span style="COLOR: #0000ff">string</span>.Format(<span style="COLOR: #a31515">"_uacct = \"{0}\";\r\nurchinTracker();\r\n"</span>, <span style="COLOR: #0000ff">this</span>.trackId), <span style="COLOR: #0000ff">true</span>);</p><p style="MARGIN: 0px">            }</p><p style="MARGIN: 0px">        }</p><p style="MARGIN: 0px"> </p><p style="MARGIN: 0px">    }</p><p style="MARGIN: 0px">}</p></div><p>Kód lze rozdělit na dvě hlavní části. První je metoda <em>Init</em>. Ta se zavolá pouze jednou, a to při startu aplikace. V ní načteme konfiguraci a pokud je v ní nějaké <em>trackId</em> pro Google Analytics uvedeno, postupujeme dále (konfigurace se tedy načítá a zpracovává jenom jednou, ne při každém požadavku).</p><p>Poté přiřadíme ke zmiňované události <em>PreRequestHandlerExecute</em> nový event handler v podobě metody <em>context_PreRequestHandlerExecute</em>. V něm se bude odehrávat vlastní generování měřícího kódu.</p><p>HTTP handler nemusí nutně být pouze web form. Může se jednat o webovou službu, samostatný handler, nebo některý ze systémových požadavků, např. na <em>WebResource.axd</em>. Proto si v prvním kroku ověříme, zda lze použitý handler přetypovat na <em>System.Web.UI.Page</em> a teprve pokud ano, pokračujeme v činnosti.</p><p>Činnost sama spočívá v zaregistrování dvou JavaScriptů, k čemuž slouží <em>System.Web.UI.Page.ClientScript</em>. Ten rozeznává tři základní typy skriptů</p><ul><li><em>ClientScriptBlock</em> - obecný blok JavaScriptového kódu, v tomto případě ho nikde nepoužíváme. </li><li><em>ClientScriptInclude</em> - odkaz na JavaScript, uložený někde jinde, vyrenderuje se jako <em>&lt;script src="...">&lt;/script></em>. </li><li><em>StartupScript</em> - JavaScriptový kód, který se vloží přímo do stránky a tedy se spustí v okamžiku natažení stránky.</li></ul><p>Každý z těchto bloků lze pojmenovat a máte k dispozici dvě metody: <em>IsXXXRegistered</em> a <em>RegisterXXX</em>.</p><p>Pomocí metod <em>IsClientScriptBlockRegistered</em> resp. <em>IsStartupScriptRegistered</em> si ověříme, zda takto pojmenované bloky do stránky už někdo nepřidat před námi. To by se v tomto případě stát nemělo, ale jistota je jistota. Poté pomocí metod <em>RegisterClientScriptInclude</em> a <em>RegisterStartupScript</em> zaregistrujeme příslušné skripty. Tím máme vyděláno, o zbytek se postará ASP.NET.</p><h2>Další možnosti využití</h2><p>Událost <em>PreRequestHandlerExecute</em> otevírá možnosti širokého uplatnění HTTP modulů pro práci s web forms, která by jinak musela být vykonávána uvnitř stránek samých. Výhodou je, že tato událost nastává na samém počátku životního cyklu stránky a tedy je možné dělat i takové věci, které jsou v pozdějších fázích nemožné - příkladně programové nastavování témat a master pages.</p><p>Použití HTTP modulu znamená univerzální řešení, které lze použít na jakoukoliv aplikaci, čistě změnou konfigurace, bez nutnosti zásahu do aplikace samé. Znamená to tedy, že je možné tuto techniku využít i pro modifikaci aplikací, od kterých nemáme k dispozici zdrojové kódy, ale jenom binární podobu.</p>

      </section>
      <section class="issues">
        <header>
          <i class="fab fa-github">​</i> Je v článku něco špatně? Chcete něco doplnit?</header>
        <p>Komentáře zde nenajdete, ale pokud je v článku chyba nebo k němu chcete něco věcného doplnit, můžete na GitHubu <a href="https://github.com/ridercz/Blog/issues/new?title=Podpora+Google+Analytics+ve+form%c4%9b+HTTP+modulu&amp;body=https://www.altair.blog/2007/05/podpora-google-analytics-ve-forme-http-modulu">otevřít nový issue</a> nebo <a href="https://github.com/ridercz/Blog/edit/master/source/2007/05/podpora-google-analytics-ve-forme-http-modulu.md">navrhnout změnu v textu</a> a poslat mi pull request.</p>
        <p>Tamtéž také najdete <a href="https://github.com/ridercz/Blog/commits/master/source/2007/05/podpora-google-analytics-ve-forme-http-modulu.md">historii všech verzí článku</a>, pokud v něm byly provedeny nějaké změny či úpravy.</p>
      </section>
      <section class="sharing">
        <span>Pošli to dál:</span>
        <ul>
          <li>
            <a href="https://twitter.com/intent/tweet?text=https://www.altair.blog/2007/05/podpora-google-analytics-ve-forme-http-modulu">
              <i class="fab fa-x-twitter">​</i>
            </a>
          </li>
          <li>
            <a href="https://www.facebook.com/sharer.php?u=https://www.altair.blog/2007/05/podpora-google-analytics-ve-forme-http-modulu">
              <i class="fab fa-facebook-f">​</i>
            </a>
          </li>
        </ul>
      </section>
    </main>
    <footer>
      <ul class="logos">
        <li>
          <img src="/content/images/logo_onwhite.svg" alt="altair.blog" style="height:38px;" />
        </li>
      </ul>
      <ul class="text">
        <li>
          Copyright © <a href="https://www.rider.cz/">Michal Altair Valášek</a>, 2003-2025</li>
        <li>
          Powered by <a href="https://www.xml4web.com/">XML4web</a> on <a href="https://www.github.com/">GitHub Pages</a></li>
        <li>
          <i class="fal fa-rss">​</i> RSS: <a href="/feed.rss">všechno</a> | <a href="/feed-internal.rss">místní</a> | <a href="/feed-external.rss">odkazy</a></li>
      </ul>
    </footer>
  </body>
</html>