<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>InstallUtil.exe – instalační a odinstalační procedury | ALTAIR.blog</title>
    <meta name="viewport" content="width=device-width,minimum-scale=1,initial-scale=1" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <meta http-equiv="Content-Language" content="cs-CZ" />
    <meta name="Description" content="Instalace ASP.NET aplikace probíhá obvykle stylem &quot;nakopíruj tohle do rootu webu a modli se&quot;. Součástí aplikace ale často bývají různé pomocné utilitky, které při své instalaci a odinstalaci vyžadují různé úkony. Například vložení do GAC, instalaci služby (Windows service), vytvoření protoklu událostí (vlastní event log a nebo alespoň event log source). Microsoft .NET framework na to má infrastrukturu v podobě instalačních tříd: užitečného, leč často přehlíženého nástroje." />
    <link rel="canonical" href="https://www.altair.blog/2010/09/installutil-exe-instalacni-a-odinstalacni-procedury" />
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/gh/tonsky/FiraCode@1.206/distr/fira_code.css" />
    <link rel="stylesheet" type="text/css" href="/content/styles.min.css?sha=ADB9BC677B325B3DF407CA8A9A72B5865E6CF3F5" />
    <link rel="stylesheet" type="text/css" href="/content/fa-5.8.1/css/all.min.css" />
    <link rel="alternate" type="application/rss+xml" href="https://www.altair.blog/feed.rss" title="RSS (všechny články)" />
    <link rel="alternate" type="application/rss+xml" href="https://www.altair.blog/feed-internal.rss" title="RSS (pouze místní články)" />
    <link rel="alternate" type="application/rss+xml" href="https://www.altair.blog/feed-external.rss" title="RSS (pouze odkazy)" />
    <link rel="shortcut icon" href="https://www.altair.blog/favicon.ico" />
    <link rel="icon" href="https://www.altair.blog/favicon.ico" />
    <meta name="twitter:card" content="summary" />
    <meta name="twitter:site" content="@ridercz" />
    <meta name="twitter:title" content="InstallUtil.exe – instalační a odinstalační procedury" />
    <meta name="twitter:description" content="Instalace ASP.NET aplikace probíhá obvykle stylem &quot;nakopíruj tohle do rootu webu a modli se&quot;. Součástí aplikace ale často bývají různé pomocné utilitky, které při své instalaci a odinstalaci vyžadují různé úkony. Například vložení do GAC, instalaci služby (Windows service), vytvoření protoklu událostí (vlastní event log a nebo alespoň event log source). Microsoft .NET framework na to má infrastrukturu v podobě instalačních tříd: užitečného, leč často přehlíženého nástroje." />
    <meta name="twitter:image" content="https://www.altair.blog/content/images/preview-1200.jpg" />
    <meta property="og:type" content="article" />
    <meta property="og:site_name" content="ALTAIR.blog" />
    <meta property="og:title" content="InstallUtil.exe – instalační a odinstalační procedury" />
    <meta property="og:description" content="Instalace ASP.NET aplikace probíhá obvykle stylem &quot;nakopíruj tohle do rootu webu a modli se&quot;. Součástí aplikace ale často bývají různé pomocné utilitky, které při své instalaci a odinstalaci vyžadují různé úkony. Například vložení do GAC, instalaci služby (Windows service), vytvoření protoklu událostí (vlastní event log a nebo alespoň event log source). Microsoft .NET framework na to má infrastrukturu v podobě instalačních tříd: užitečného, leč často přehlíženého nástroje." />
    <meta name="og:image" content="https://www.altair.blog/content/images/preview-1200.jpg" />
    <meta property="og:locale" content="cs_CZ" />
    <meta property="og:url" content="https://www.altair.blog/2010/09/installutil-exe-instalacni-a-odinstalacni-procedury" />
    <script>
      (function(f, a, t, h, o, m){
        a[h]=a[h]||function(){
          (a[h].q=a[h].q||[]).push(arguments)
        };
        o=f.createElement('script'),
        m=f.getElementsByTagName('script')[0];
        o.async=1; o.src=t; o.id='fathom-script';
        m.parentNode.insertBefore(o,m)
      })(document, window, '//stats.altair.blog/tracker.js', 'fathom');
      fathom('set', 'siteId', 'OBOTR');
      fathom('trackPageview');
    </script>
    <meta name="robots" content="index, follow" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.13.1/styles/default.min.css" integrity="sha256-Zd1icfZ72UBmsId/mUcagrmN7IN5Qkrvh75ICHIQVTk=" crossorigin="anonymous" />
  </head>
  <body>
    <header>
      <div>
        <a href="/">
          <img src="/content/images/logo_onblack.svg" alt="altair.blog" style="max-height:100px;max-width:80%" />
        </a>
      </div>
    </header>
    <nav>
      <ul>
        <li>
          <a href="https://www.rider.cz/" title="Autor: Michal Altair Valášek">
            <i class="fal fa-fw fa-user"> </i>
          </a>
        </li>
        <li>
          <a href="/archive" title="Archiv článků">
            <i class="fal fa-fw fa-archive"> </i>
          </a>
        </li>
        <li>
          <a href="/categories" title="Rubriky">
            <i class="fal fa-fw fa-tags"> </i>
          </a>
        </li>
        <li>
          <a href="/serials" title="Seriály">
            <i class="fal fa-fw fa-list-alt"> </i>
          </a>
        </li>
        <li>
          <a href="/search" title="Vyhledávání">
            <i class="fal fa-fw fa-search"> </i>
          </a>
        </li>
        <li>
          <a href="https://www.rider.cz/#contact" title="Kontakt">
            <i class="fal fa-fw fa-envelope"> </i>
          </a>
        </li>
        <li>
          <a href="https://facebook.com/rider.cz" title="Facebook">
            <i class="fab fa-fw fa-facebook"> </i>
          </a>
        </li>
        <li>
          <a href="https://twitter.com/ridercz" title="Twitter">
            <i class="fab fa-twitter"> </i>
          </a>
        </li>
        <li>
          <a href="https://github.com/ridercz" title="Github">
            <i class="fab fa-fw fa-github"> </i>
          </a>
        </li>
        <li>
          <a href="https://ask.fm/ridercz" title="Ask.fm">
            <i class="fal fa-fw fa-question"> </i>
          </a>
        </li>
      </ul>
    </nav>
    <main>
      <h1>InstallUtil.exe – instalační a odinstalační procedury</h1>
      <aside class="article-info">
        <ul class="categories">
          <li>
            <a href="/categories/it" title="Rubrika">
              <i class="fal fa-tag"> </i>IT</a>
          </li>
        </ul>
        <div>
          <a href="https://www.rider.cz/">Michal Altair Valášek </a>
          <i class="fal fa-user">​</i>
        </div>
        <div>
          <time datetime="2010-09-23T21:55:56.007+02:00" title="Datum vydání">23. září 2010 <i class="fal fa-calendar-alt">​</i></time>
        </div>
      </aside>
      <section class="article-text">
        <p>Instalace ASP.NET aplikace probíhá obvykle stylem &quot;nakopíruj tohle do rootu webu a modli se&quot;. Součástí aplikace ale často bývají různé pomocné utilitky, které při své instalaci a odinstalaci vyžadují různé úkony. Například vložení do GAC, instalaci služby (Windows service), vytvoření protoklu událostí (vlastní event log a nebo alespoň event log source). Microsoft .NET framework na to má infrastrukturu v podobě instalačních tříd: užitečného, leč často přehlíženého nástroje.</p>  <p>Hned na úvod je nutné upozornit na jednu důležitou věc: v tomto článku nebude řeč o vytváření instalačních balíčků, setup projektech, MSI a podobných věcech. Zaměříme se na specifické činnost, které konkrétní assemblies potřebují k životu.Ty lze vyvolat buďto ručně, pomocí utility InstallUtil.exe, která je součástí .NET Frameworku, nebo v rámci &quot;velké&quot; instalace, jako jsou např. různé formy setup projektů ve Visual Studiu.</p>  <h2>Jak funguje InstallUtil.exe</h2>  <p>Utilitka <em>InstallUtil.exe</em> je součástí .NET Frameworku. Slouží k instalaci a odinstalaci assembly, přičemž záleží pouze na assembly samotné, jaké konkrétní úkony bude instalace a odinstalace zahrnovat. Jedná se o konzolový program, který se spouští z příkazové řádky a ovládá se pomocí parametrů. Jeho nejtypičtější použití nicméně je pouze s názvem assembly, pro instalaci:</p>  <pre style="font-family: "><font face="Consolas"><font style="font-size: 12pt">InstallUtil.exe C:\Cesta\k\assembly.dll</font></font></pre>
<p>Odinstalace se pak provádí přidáním parametru /u:</p>
<pre style="font-family: "><font face="Consolas"><font style="font-size: 12pt">InstallUtil.exe /u C:\Cesta\k\assembly.dll</font></font><br></pre>
<p>Assembly přitom může být jak spustitelný program (<em>.exe</em>), tak cokoliv jiného, třeba class library (<em>.dll</em>). Toho jsem využil například ve svém modulu pro obcházení AES chyby v ASP.NET, o kterém jsem psal před pár dny. Je potřeba ho nainstalovat, konkrétně vložit tuto assembly do GAC a zaregistrovat HTTP modul na úrovni serveru.</p>
<p>Vytvářet pro tak jednoduchou aplikaci kompletní setup by byl poněkud overkill. Ruční instalace by byla zase dost komplikovaná, zejména pak proto, že <em>GacUtil.exe</em>, používaná pro ruční instalaci assembly do GAC, není součástí .NET Frameworku ale jen SDK, takže na serveru patrně nebude nainstalovaná. Proto jsem použil instalátory a <em>InstallUtil.exe</em>.</p>
<p>InstallUtil funguje tak, že v dané assembly najde všechy instalační třídy, označené atributem <em>[RunInstaller(true)]</em> a v nich spustí metodu <em>Install</em>, potažmo <em>Uninstall</em>.</p>
<h2>Instalační třídy</h2>
<p>Pro potřeby instalace se používají instalační třídy (installer classes). Ve své podstatě jde o běžnou třídu, která je poděděná od <em>System.Configuration.Install.Installer</em>. V ní přepíšeme metody <em>Install</em> a <em>Uninstall</em> a do nich doplníme logiku, kterou naše instalace vyžaduje.</p>
<p>Můžeme vytvořit například třídu <em>AssemblyGacInstaller</em>, která vloží aktuální assembly do Global Assembly Cache (a v případě odinstalace ji zase odstraní). Je velmi jednoduchá, nemá žádné parametry, a vypadá takto:</p>
<pre style="margin-top: auto; font-family: ; margin-bottom: auto"><font face="Consolas"><span style="color: "><font style="font-size: 12pt" color="#0000ff">using</font></span><font style="font-size: 12pt"> System;</font></font><br><font face="Consolas"><span style="color: "><font style="font-size: 12pt" color="#0000ff">using</font></span><font style="font-size: 12pt"> System.Collections;</font></font><br><font face="Consolas"><span style="color: "><font style="font-size: 12pt" color="#0000ff">using</font></span><font style="font-size: 12pt"> System.Configuration.Install;</font></font><br><font face="Consolas"><font style="font-size: 12pt"> </font></font><br><font face="Consolas"><span style="color: "><font style="font-size: 12pt" color="#0000ff">namespace</font></span><font style="font-size: 12pt"> Altairis.Web.OracleBugFix.Install {</font></font><br><font face="Consolas"><font style="font-size: 12pt">&#160;&#160;&#160; </font><span style="color: "><font style="font-size: 12pt" color="#0000ff">public</font></span><font style="font-size: 12pt">&#160;</font><span style="color: "><font style="font-size: 12pt" color="#0000ff">partial</font></span><font style="font-size: 12pt">&#160;</font><span style="color: "><font style="font-size: 12pt" color="#0000ff">class</font></span><font style="font-size: 12pt">&#160;</font><span style="color: "><font style="font-size: 12pt" color="#2b91af">AssemblyGacInstaller</font></span><font style="font-size: 12pt"> : </font><span style="color: "><font style="font-size: 12pt" color="#2b91af">Installer</font></span><font style="font-size: 12pt"> {</font></font><br><font face="Consolas"><font style="font-size: 12pt"> </font></font><br><font face="Consolas"><font style="font-size: 12pt">&#160;&#160;&#160;&#160;&#160;&#160;&#160; </font><span style="color: "><font style="font-size: 12pt" color="#008000">// Installer methods</font></span></font><br><font face="Consolas"><font style="font-size: 12pt"> </font></font><br><font face="Consolas"><font style="font-size: 12pt">&#160;&#160;&#160;&#160;&#160;&#160;&#160; </font><span style="color: "><font style="font-size: 12pt" color="#0000ff">public</font></span><font style="font-size: 12pt">&#160;</font><span style="color: "><font style="font-size: 12pt" color="#0000ff">override</font></span><font style="font-size: 12pt">&#160;</font><span style="color: "><font style="font-size: 12pt" color="#0000ff">void</font></span><font style="font-size: 12pt"> Install(</font><span style="color: "><font style="font-size: 12pt" color="#2b91af">IDictionary</font></span><font style="font-size: 12pt"> stateSaver) {</font></font><br><font face="Consolas"><font style="font-size: 12pt">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </font><span style="color: "><font style="font-size: 12pt" color="#008000">// Base install task</font></span></font><br><font face="Consolas"><font style="font-size: 12pt">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </font><span style="color: "><font style="font-size: 12pt" color="#0000ff">base</font></span><font style="font-size: 12pt">.Install(stateSaver);</font></font><br><font face="Consolas"><font style="font-size: 12pt"> </font></font><br><font face="Consolas"><font style="font-size: 12pt">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </font><span style="color: "><font style="font-size: 12pt" color="#008000">// Install current assembly to GAC</font></span></font><br><font face="Consolas"><font style="font-size: 12pt">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </font><span style="color: "><font style="font-size: 12pt" color="#0000ff">try</font></span><font style="font-size: 12pt"> {</font></font><br><font face="Consolas"><font style="font-size: 12pt">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </font><span style="color: "><font style="font-size: 12pt" color="#2b91af">Console</font></span><font style="font-size: 12pt">.Write(</font><span style="color: "><font style="font-size: 12pt" color="#a31515">&quot;Installing assembly to GAC...&quot;</font></span><font style="font-size: 12pt">);</font></font><br><font face="Consolas"><font style="font-size: 12pt">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </font><span style="color: "><font style="font-size: 12pt" color="#0000ff">var</font></span><font style="font-size: 12pt"> mya = System.Reflection.</font><span style="color: "><font style="font-size: 12pt" color="#2b91af">Assembly</font></span><font style="font-size: 12pt">.GetExecutingAssembly();</font></font><br><font face="Consolas"><font style="font-size: 12pt">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </font><span style="color: "><font style="font-size: 12pt" color="#0000ff">var</font></span><font style="font-size: 12pt"> p = </font><span style="color: "><font style="font-size: 12pt" color="#0000ff">new</font></span><font style="font-size: 12pt"> System.EnterpriseServices.Internal.</font><span style="color: "><font style="font-size: 12pt" color="#2b91af">Publish</font></span><font style="font-size: 12pt">();</font></font><br><font face="Consolas"><font style="font-size: 12pt">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; p.GacInstall(mya.Location);</font></font><br><font face="Consolas"><font style="font-size: 12pt">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </font><span style="color: "><font style="font-size: 12pt" color="#2b91af">Console</font></span><font style="font-size: 12pt">.WriteLine(</font><span style="color: "><font style="font-size: 12pt" color="#a31515">&quot;OK&quot;</font></span><font style="font-size: 12pt">);</font></font><br><font face="Consolas"><font style="font-size: 12pt">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; }</font></font><br><font face="Consolas"><font style="font-size: 12pt">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </font><span style="color: "><font style="font-size: 12pt" color="#0000ff">catch</font></span><font style="font-size: 12pt"> (</font><span style="color: "><font style="font-size: 12pt" color="#2b91af">Exception</font></span><font style="font-size: 12pt"> ex) {</font></font><br><font face="Consolas"><font style="font-size: 12pt">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </font><span style="color: "><font style="font-size: 12pt" color="#2b91af">Console</font></span><font style="font-size: 12pt">.WriteLine(</font><span style="color: "><font style="font-size: 12pt" color="#a31515">&quot;Failed!&quot;</font></span><font style="font-size: 12pt">);</font></font><br><font face="Consolas"><font style="font-size: 12pt">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </font><span style="color: "><font style="font-size: 12pt" color="#2b91af">Console</font></span><font style="font-size: 12pt">.WriteLine(ex.ToString());</font></font><br><font face="Consolas"><font style="font-size: 12pt">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; }</font></font><br><font face="Consolas"><font style="font-size: 12pt">&#160;&#160;&#160;&#160;&#160;&#160;&#160; }</font></font><br><font face="Consolas"><font style="font-size: 12pt"> </font></font><br><font face="Consolas"><font style="font-size: 12pt">&#160;&#160;&#160;&#160;&#160;&#160;&#160; </font><span style="color: "><font style="font-size: 12pt" color="#0000ff">public</font></span><font style="font-size: 12pt">&#160;</font><span style="color: "><font style="font-size: 12pt" color="#0000ff">override</font></span><font style="font-size: 12pt">&#160;</font><span style="color: "><font style="font-size: 12pt" color="#0000ff">void</font></span><font style="font-size: 12pt"> Uninstall(</font><span style="color: "><font style="font-size: 12pt" color="#2b91af">IDictionary</font></span><font style="font-size: 12pt"> savedState) {</font></font><br><font face="Consolas"><font style="font-size: 12pt">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </font><span style="color: "><font style="font-size: 12pt" color="#008000">// Base uninstall task</font></span></font><br><font face="Consolas"><font style="font-size: 12pt">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </font><span style="color: "><font style="font-size: 12pt" color="#0000ff">base</font></span><font style="font-size: 12pt">.Uninstall(savedState);</font></font><br><font face="Consolas"><font style="font-size: 12pt"> </font></font><br><font face="Consolas"><font style="font-size: 12pt">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </font><span style="color: "><font style="font-size: 12pt" color="#008000">// Remove current assembly from GAC</font></span></font><br><font face="Consolas"><font style="font-size: 12pt">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </font><span style="color: "><font style="font-size: 12pt" color="#0000ff">try</font></span><font style="font-size: 12pt"> {</font></font><br><font face="Consolas"><font style="font-size: 12pt">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </font><span style="color: "><font style="font-size: 12pt" color="#2b91af">Console</font></span><font style="font-size: 12pt">.Write(</font><span style="color: "><font style="font-size: 12pt" color="#a31515">&quot;Removing assembly from GAC...&quot;</font></span><font style="font-size: 12pt">);</font></font><br><font face="Consolas"><font style="font-size: 12pt">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </font><span style="color: "><font style="font-size: 12pt" color="#0000ff">var</font></span><font style="font-size: 12pt"> mya = System.Reflection.</font><span style="color: "><font style="font-size: 12pt" color="#2b91af">Assembly</font></span><font style="font-size: 12pt">.GetExecutingAssembly();</font></font><br><font face="Consolas"><font style="font-size: 12pt">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </font><span style="color: "><font style="font-size: 12pt" color="#0000ff">var</font></span><font style="font-size: 12pt"> p = </font><span style="color: "><font style="font-size: 12pt" color="#0000ff">new</font></span><font style="font-size: 12pt"> System.EnterpriseServices.Internal.</font><span style="color: "><font style="font-size: 12pt" color="#2b91af">Publish</font></span><font style="font-size: 12pt">();</font></font><br><font face="Consolas"><font style="font-size: 12pt">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; p.GacRemove(mya.Location);</font></font><br><font face="Consolas"><font style="font-size: 12pt">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </font><span style="color: "><font style="font-size: 12pt" color="#2b91af">Console</font></span><font style="font-size: 12pt">.WriteLine(</font><span style="color: "><font style="font-size: 12pt" color="#a31515">&quot;OK&quot;</font></span><font style="font-size: 12pt">);</font></font><br><font face="Consolas"><font style="font-size: 12pt">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; }</font></font><br><font face="Consolas"><font style="font-size: 12pt">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </font><span style="color: "><font style="font-size: 12pt" color="#0000ff">catch</font></span><font style="font-size: 12pt"> (</font><span style="color: "><font style="font-size: 12pt" color="#2b91af">Exception</font></span><font style="font-size: 12pt"> ex) {</font></font><br><font face="Consolas"><font style="font-size: 12pt">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </font><span style="color: "><font style="font-size: 12pt" color="#2b91af">Console</font></span><font style="font-size: 12pt">.WriteLine(</font><span style="color: "><font style="font-size: 12pt" color="#a31515">&quot;Failed!&quot;</font></span><font style="font-size: 12pt">);</font></font><br><font face="Consolas"><font style="font-size: 12pt">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </font><span style="color: "><font style="font-size: 12pt" color="#2b91af">Console</font></span><font style="font-size: 12pt">.WriteLine(ex.ToString());</font></font><br><font face="Consolas"><font style="font-size: 12pt">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; }</font></font><br><font face="Consolas"><font style="font-size: 12pt">&#160;&#160;&#160;&#160;&#160;&#160;&#160; }</font></font><br><font face="Consolas"><font style="font-size: 12pt"> </font></font><br><font face="Consolas"><font style="font-size: 12pt">&#160;&#160;&#160; }</font></font><br><font face="Consolas"><font style="font-size: 12pt">}</font></font><br></pre>
<h2>InstallState</h2>
<p>Instalátor může být i podstatně sofistikovanější. Často vyžaduje mezi instalací a odinstalací uchovávání nějakých informací, potřebných pro uvedení počítače do původního stavu. Takové informace si v metodě <em>Install</em> můžete ukládat do kolekce <em>stateSaver</em>. Instalační utilita je potom serializuje do souboru, který se standardně jmenuje <em>JménoAssembly.InstallState</em>. V případě odinstalace se pak informace deserializují a dostanete je v rámci parametru <em>savedState</em> metody <em>Uninstall</em>.</p>
<p>Následující instalační třída slouží k registraci HTTP modulu na úrovni celého web serveru. Do install state si uloží jméno, pod kterým byl&#160; modul do konfigurace vložen:</p>
<p><font face="Consolas"><span style="color: "><font style="font-size: 12pt" color="#0000ff">using</font></span><font style="font-size: 12pt"> System;</font></font> 
<p><br><font face="Consolas"><span style="color: "><font style="font-size: 12pt" color="#0000ff">using</font></span><font style="font-size: 12pt"> System.Collections;</font></font></p>
<p><br><font face="Consolas"><span style="color: "><font style="font-size: 12pt" color="#0000ff">using</font></span><font style="font-size: 12pt"> Microsoft.Web.Administration;</font></font></p>
<p><br><font face="Consolas"><font style="font-size: 12pt"></font></font></p>
<p><br><font face="Consolas"><span style="color: "><font style="font-size: 12pt" color="#0000ff">namespace</font></span><font style="font-size: 12pt"> Altairis.Web.OracleBugFix.Install {</font></font></p>
<p><br><font face="Consolas"><font style="font-size: 12pt">    </font><span style="color: "><font style="font-size: 12pt" color="#0000ff">public</font></span><font style="font-size: 12pt"> </font><span style="color: "><font style="font-size: 12pt" color="#0000ff">partial</font></span><font style="font-size: 12pt"> </font><span style="color: "><font style="font-size: 12pt" color="#0000ff">class</font></span><font style="font-size: 12pt"> </font><span style="color: "><font style="font-size: 12pt" color="#2b91af">HttpModuleInstaller</font></span><font style="font-size: 12pt"> : System.Configuration.Install.</font><span style="color: "><font style="font-size: 12pt" color="#2b91af">Installer</font></span><font style="font-size: 12pt"> {</font></font></p>
<p><br><font face="Consolas"><font style="font-size: 12pt"></font></font></p>
<p><br><font face="Consolas"><font style="font-size: 12pt">        </font><span style="color: "><font style="font-size: 12pt" color="#008000">// Configuration properties</font></span></font></p>
<p><br><font face="Consolas"><font style="font-size: 12pt"></font></font></p>
<p><br><font face="Consolas"><font style="font-size: 12pt">        </font><span style="color: "><font style="font-size: 12pt" color="#0000ff">public</font></span><font style="font-size: 12pt"> </font><span style="color: "><font style="font-size: 12pt" color="#0000ff">string</font></span><font style="font-size: 12pt"> ModuleName { </font><span style="color: "><font style="font-size: 12pt" color="#0000ff">get</font></span><font style="font-size: 12pt">; </font><span style="color: "><font style="font-size: 12pt" color="#0000ff">set</font></span><font style="font-size: 12pt">; }</font></font></p>
<p><br><font face="Consolas"><font style="font-size: 12pt"></font></font></p>
<p><br><font face="Consolas"><font style="font-size: 12pt">        </font><span style="color: "><font style="font-size: 12pt" color="#0000ff">public</font></span><font style="font-size: 12pt"> </font><span style="color: "><font style="font-size: 12pt" color="#2b91af">Type</font></span><font style="font-size: 12pt"> ModuleType { </font><span style="color: "><font style="font-size: 12pt" color="#0000ff">get</font></span><font style="font-size: 12pt">; </font><span style="color: "><font style="font-size: 12pt" color="#0000ff">set</font></span><font style="font-size: 12pt">; }</font></font></p>
<p><br><font face="Consolas"><font style="font-size: 12pt"></font></font></p>
<p><br><font face="Consolas"><font style="font-size: 12pt">        </font><span style="color: "><font style="font-size: 12pt" color="#008000">// Installer methods</font></span></font></p>
<p><br><font face="Consolas"><font style="font-size: 12pt"></font></font></p>
<p><br><font face="Consolas"><font style="font-size: 12pt">        </font><span style="color: "><font style="font-size: 12pt" color="#0000ff">public</font></span><font style="font-size: 12pt"> </font><span style="color: "><font style="font-size: 12pt" color="#0000ff">override</font></span><font style="font-size: 12pt"> </font><span style="color: "><font style="font-size: 12pt" color="#0000ff">void</font></span><font style="font-size: 12pt"> Install(</font><span style="color: "><font style="font-size: 12pt" color="#2b91af">IDictionary</font></span><font style="font-size: 12pt"> stateSaver) {</font></font></p>
<p><br><font face="Consolas"><font style="font-size: 12pt">            </font><span style="color: "><font style="font-size: 12pt" color="#008000">// Base install tasks</font></span></font></p>
<p><br><font face="Consolas"><font style="font-size: 12pt">            </font><span style="color: "><font style="font-size: 12pt" color="#0000ff">base</font></span><font style="font-size: 12pt">.Install(stateSaver);</font></font></p>
<p><br><font face="Consolas"><font style="font-size: 12pt"></font></font></p>
<p><br><font face="Consolas"><font style="font-size: 12pt">            </font><span style="color: "><font style="font-size: 12pt" color="#008000">// Validate properties</font></span></font></p>
<p><br><font face="Consolas"><font style="font-size: 12pt">            </font><span style="color: "><font style="font-size: 12pt" color="#0000ff">if</font></span><font style="font-size: 12pt"> (</font><span style="color: "><font style="font-size: 12pt" color="#0000ff">string</font></span><font style="font-size: 12pt">.IsNullOrEmpty(</font><span style="color: "><font style="font-size: 12pt" color="#0000ff">this</font></span><font style="font-size: 12pt">.ModuleName)) </font><span style="color: "><font style="font-size: 12pt" color="#0000ff">throw</font></span><font style="font-size: 12pt"> </font><span style="color: "><font style="font-size: 12pt" color="#0000ff">new</font></span><font style="font-size: 12pt"> </font><span style="color: "><font style="font-size: 12pt" color="#2b91af">ArgumentException</font></span><font style="font-size: 12pt">(</font><span style="color: "><font style="font-size: 12pt" color="#a31515">&quot;ModuleName is null or empty.&quot;</font></span><font style="font-size: 12pt">);</font></font></p>
<p><br><font face="Consolas"><font style="font-size: 12pt">            </font><span style="color: "><font style="font-size: 12pt" color="#0000ff">if</font></span><font style="font-size: 12pt"> (</font><span style="color: "><font style="font-size: 12pt" color="#0000ff">this</font></span><font style="font-size: 12pt">.ModuleType == </font><span style="color: "><font style="font-size: 12pt" color="#0000ff">null</font></span><font style="font-size: 12pt">) </font><span style="color: "><font style="font-size: 12pt" color="#0000ff">throw</font></span><font style="font-size: 12pt"> </font><span style="color: "><font style="font-size: 12pt" color="#0000ff">new</font></span><font style="font-size: 12pt"> </font><span style="color: "><font style="font-size: 12pt" color="#2b91af">ArgumentNullException</font></span><font style="font-size: 12pt">(</font><span style="color: "><font style="font-size: 12pt" color="#a31515">&quot;ModuleType&quot;</font></span><font style="font-size: 12pt">);</font></font></p>
<p><br><font face="Consolas"><font style="font-size: 12pt"></font></font></p>
<p><br><font face="Consolas"><font style="font-size: 12pt">            </font><span style="color: "><font style="font-size: 12pt" color="#0000ff">try</font></span><font style="font-size: 12pt"> {</font></font></p>
<p><br><font face="Consolas"><font style="font-size: 12pt">                </font><span style="color: "><font style="font-size: 12pt" color="#008000">// Install module to IIS</font></span></font></p>
<p><br><font face="Consolas"><font style="font-size: 12pt">                </font><span style="color: "><font style="font-size: 12pt" color="#2b91af">Console</font></span><font style="font-size: 12pt">.Write(</font><span style="color: "><font style="font-size: 12pt" color="#a31515">&quot;Loading server configuration...&quot;</font></span><font style="font-size: 12pt">);</font></font></p>
<p><br><font face="Consolas"><font style="font-size: 12pt">                </font><span style="color: "><font style="font-size: 12pt" color="#0000ff">using</font></span><font style="font-size: 12pt"> (</font><span style="color: "><font style="font-size: 12pt" color="#2b91af">ServerManager</font></span><font style="font-size: 12pt"> serverManager = </font><span style="color: "><font style="font-size: 12pt" color="#0000ff">new</font></span><font style="font-size: 12pt"> </font><span style="color: "><font style="font-size: 12pt" color="#2b91af">ServerManager</font></span><font style="font-size: 12pt">()) {</font></font></p>
<p><br><font face="Consolas"><font style="font-size: 12pt">                    </font><span style="color: "><font style="font-size: 12pt" color="#2b91af">Configuration</font></span><font style="font-size: 12pt"> config = serverManager.GetApplicationHostConfiguration();</font></font></p>
<p><br><font face="Consolas"><font style="font-size: 12pt">                    </font><span style="color: "><font style="font-size: 12pt" color="#2b91af">ConfigurationSection</font></span><font style="font-size: 12pt"> modulesSection = config.GetSection(</font><span style="color: "><font style="font-size: 12pt" color="#a31515">&quot;system.webServer/modules&quot;</font></span><font style="font-size: 12pt">);</font></font></p>
<p><br><font face="Consolas"><font style="font-size: 12pt">                    </font><span style="color: "><font style="font-size: 12pt" color="#2b91af">ConfigurationElementCollection</font></span><font style="font-size: 12pt"> modulesCollection = modulesSection.GetCollection();</font></font></p>
<p><br><font face="Consolas"><font style="font-size: 12pt">                    </font><span style="color: "><font style="font-size: 12pt" color="#2b91af">Console</font></span><font style="font-size: 12pt">.WriteLine(</font><span style="color: "><font style="font-size: 12pt" color="#a31515">&quot;OK&quot;</font></span><font style="font-size: 12pt">);</font></font></p>
<p><br><font face="Consolas"><font style="font-size: 12pt"></font></font></p>
<p><br><font face="Consolas"><font style="font-size: 12pt">                    </font><span style="color: "><font style="font-size: 12pt" color="#2b91af">Console</font></span><font style="font-size: 12pt">.Write(</font><span style="color: "><font style="font-size: 12pt" color="#a31515">&quot;Installing module...&quot;</font></span><font style="font-size: 12pt">);</font></font></p>
<p><br><font face="Consolas"><font style="font-size: 12pt">                    </font><span style="color: "><font style="font-size: 12pt" color="#2b91af">ConfigurationElement</font></span><font style="font-size: 12pt"> addElement = modulesCollection.CreateElement(</font><span style="color: "><font style="font-size: 12pt" color="#a31515">&quot;add&quot;</font></span><font style="font-size: 12pt">);</font></font></p>
<p><br><font face="Consolas"><font style="font-size: 12pt">                    addElement[</font><span style="color: "><font style="font-size: 12pt" color="#a31515">&quot;name&quot;</font></span><font style="font-size: 12pt">] = </font><span style="color: "><font style="font-size: 12pt" color="#0000ff">this</font></span><font style="font-size: 12pt">.ModuleName;</font></font></p>
<p><br><font face="Consolas"><font style="font-size: 12pt">                    addElement[</font><span style="color: "><font style="font-size: 12pt" color="#a31515">&quot;type&quot;</font></span><font style="font-size: 12pt">] = </font><span style="color: "><font style="font-size: 12pt" color="#0000ff">this</font></span><font style="font-size: 12pt">.ModuleType.AssemblyQualifiedName;</font></font></p>
<p><br><font face="Consolas"><font style="font-size: 12pt">                    modulesCollection.Add(addElement);</font></font></p>
<p><br><font face="Consolas"><font style="font-size: 12pt">                    </font><span style="color: "><font style="font-size: 12pt" color="#2b91af">Console</font></span><font style="font-size: 12pt">.WriteLine(</font><span style="color: "><font style="font-size: 12pt" color="#a31515">&quot;OK&quot;</font></span><font style="font-size: 12pt">);</font></font></p>
<p><br><font face="Consolas"><font style="font-size: 12pt"></font></font></p>
<p><br><font face="Consolas"><font style="font-size: 12pt">                    </font><span style="color: "><font style="font-size: 12pt" color="#2b91af">Console</font></span><font style="font-size: 12pt">.Write(</font><span style="color: "><font style="font-size: 12pt" color="#a31515">&quot;Saving changes...&quot;</font></span><font style="font-size: 12pt">);</font></font></p>
<p><br><font face="Consolas"><font style="font-size: 12pt">                    serverManager.CommitChanges();</font></font></p>
<p><br><font face="Consolas"><font style="font-size: 12pt">                    </font><span style="color: "><font style="font-size: 12pt" color="#2b91af">Console</font></span><font style="font-size: 12pt">.WriteLine(</font><span style="color: "><font style="font-size: 12pt" color="#a31515">&quot;OK&quot;</font></span><font style="font-size: 12pt">);</font></font></p>
<p><br><font face="Consolas"><font style="font-size: 12pt">                }</font></font></p>
<p><br><font face="Consolas"><font style="font-size: 12pt"></font></font></p>
<p><br><font face="Consolas"><font style="font-size: 12pt">                </font><span style="color: "><font style="font-size: 12pt" color="#008000">// Add module name to install state</font></span></font></p>
<p><br><font face="Consolas"><font style="font-size: 12pt">                stateSaver.Add(</font><span style="color: "><font style="font-size: 12pt" color="#a31515">&quot;ModuleName&quot;</font></span><font style="font-size: 12pt">, </font><span style="color: "><font style="font-size: 12pt" color="#0000ff">this</font></span><font style="font-size: 12pt">.ModuleName);</font></font></p>
<p><br><font face="Consolas"><font style="font-size: 12pt">            }</font></font></p>
<p><br><font face="Consolas"><font style="font-size: 12pt">            </font><span style="color: "><font style="font-size: 12pt" color="#0000ff">catch</font></span><font style="font-size: 12pt"> (</font><span style="color: "><font style="font-size: 12pt" color="#2b91af">Exception</font></span><font style="font-size: 12pt"> ex) {</font></font></p>
<p><br><font face="Consolas"><font style="font-size: 12pt">                </font><span style="color: "><font style="font-size: 12pt" color="#2b91af">Console</font></span><font style="font-size: 12pt">.WriteLine(</font><span style="color: "><font style="font-size: 12pt" color="#a31515">&quot;Failed!&quot;</font></span><font style="font-size: 12pt">);</font></font></p>
<p><br><font face="Consolas"><font style="font-size: 12pt">                </font><span style="color: "><font style="font-size: 12pt" color="#2b91af">Console</font></span><font style="font-size: 12pt">.WriteLine(ex.ToString());</font></font></p>
<p><br><font face="Consolas"><font style="font-size: 12pt">            }</font></font></p>
<p><br><font face="Consolas"><font style="font-size: 12pt">        }</font></font></p>
<p><br><font face="Consolas"><font style="font-size: 12pt"></font></font></p>
<p><br><font face="Consolas"><font style="font-size: 12pt">        </font><span style="color: "><font style="font-size: 12pt" color="#0000ff">public</font></span><font style="font-size: 12pt"> </font><span style="color: "><font style="font-size: 12pt" color="#0000ff">override</font></span><font style="font-size: 12pt"> </font><span style="color: "><font style="font-size: 12pt" color="#0000ff">void</font></span><font style="font-size: 12pt"> Uninstall(</font><span style="color: "><font style="font-size: 12pt" color="#2b91af">IDictionary</font></span><font style="font-size: 12pt"> savedState) {</font></font></p>
<p><br><font face="Consolas"><font style="font-size: 12pt">            </font><span style="color: "><font style="font-size: 12pt" color="#008000">// Base uninstall task</font></span></font></p>
<p><br><font face="Consolas"><font style="font-size: 12pt">            </font><span style="color: "><font style="font-size: 12pt" color="#0000ff">base</font></span><font style="font-size: 12pt">.Uninstall(savedState);</font></font></p>
<p><br><font face="Consolas"><font style="font-size: 12pt"></font></font></p>
<p><br><font face="Consolas"><font style="font-size: 12pt">            </font><span style="color: "><font style="font-size: 12pt" color="#008000">// Load installed module name</font></span></font></p>
<p><br><font face="Consolas"><font style="font-size: 12pt">            </font><span style="color: "><font style="font-size: 12pt" color="#0000ff">if</font></span><font style="font-size: 12pt"> (savedState == </font><span style="color: "><font style="font-size: 12pt" color="#0000ff">null</font></span><font style="font-size: 12pt">) </font><span style="color: "><font style="font-size: 12pt" color="#0000ff">throw</font></span><font style="font-size: 12pt"> </font><span style="color: "><font style="font-size: 12pt" color="#0000ff">new</font></span><font style="font-size: 12pt"> </font><span style="color: "><font style="font-size: 12pt" color="#2b91af">ArgumentNullException</font></span><font style="font-size: 12pt">(</font><span style="color: "><font style="font-size: 12pt" color="#a31515">&quot;savedState&quot;</font></span><font style="font-size: 12pt">);</font></font></p>
<p><br><font face="Consolas"><font style="font-size: 12pt">            </font><span style="color: "><font style="font-size: 12pt" color="#0000ff">var</font></span><font style="font-size: 12pt"> moduleName = savedState[</font><span style="color: "><font style="font-size: 12pt" color="#a31515">&quot;ModuleName&quot;</font></span><font style="font-size: 12pt">] </font><span style="color: "><font style="font-size: 12pt" color="#0000ff">as</font></span><font style="font-size: 12pt"> </font><span style="color: "><font style="font-size: 12pt" color="#0000ff">string</font></span><font style="font-size: 12pt">;</font></font></p>
<p><br><font face="Consolas"><font style="font-size: 12pt">            </font><span style="color: "><font style="font-size: 12pt" color="#0000ff">if</font></span><font style="font-size: 12pt"> (</font><span style="color: "><font style="font-size: 12pt" color="#0000ff">string</font></span><font style="font-size: 12pt">.IsNullOrEmpty(moduleName)) </font><span style="color: "><font style="font-size: 12pt" color="#0000ff">throw</font></span><font style="font-size: 12pt"> </font><span style="color: "><font style="font-size: 12pt" color="#0000ff">new</font></span><font style="font-size: 12pt"> </font><span style="color: "><font style="font-size: 12pt" color="#2b91af">ArgumentException</font></span><font style="font-size: 12pt">(</font><span style="color: "><font style="font-size: 12pt" color="#a31515">&quot;Module name not available in saved state.&quot;</font></span><font style="font-size: 12pt">);</font></font></p>
<p><br><font face="Consolas"><font style="font-size: 12pt"></font></font></p>
<p><br><font face="Consolas"><font style="font-size: 12pt">            </font><span style="color: "><font style="font-size: 12pt" color="#0000ff">try</font></span><font style="font-size: 12pt"> {</font></font></p>
<p><br><font face="Consolas"><font style="font-size: 12pt">                </font><span style="color: "><font style="font-size: 12pt" color="#2b91af">Console</font></span><font style="font-size: 12pt">.Write(</font><span style="color: "><font style="font-size: 12pt" color="#a31515">&quot;Loading server configuration...&quot;</font></span><font style="font-size: 12pt">);</font></font></p>
<p><br><font face="Consolas"><font style="font-size: 12pt">                </font><span style="color: "><font style="font-size: 12pt" color="#0000ff">using</font></span><font style="font-size: 12pt"> (</font><span style="color: "><font style="font-size: 12pt" color="#2b91af">ServerManager</font></span><font style="font-size: 12pt"> serverManager = </font><span style="color: "><font style="font-size: 12pt" color="#0000ff">new</font></span><font style="font-size: 12pt"> </font><span style="color: "><font style="font-size: 12pt" color="#2b91af">ServerManager</font></span><font style="font-size: 12pt">()) {</font></font></p>
<p><br><font face="Consolas"><font style="font-size: 12pt">                    </font><span style="color: "><font style="font-size: 12pt" color="#2b91af">Configuration</font></span><font style="font-size: 12pt"> config = serverManager.GetApplicationHostConfiguration();</font></font></p>
<p><br><font face="Consolas"><font style="font-size: 12pt">                    </font><span style="color: "><font style="font-size: 12pt" color="#2b91af">ConfigurationSection</font></span><font style="font-size: 12pt"> modulesSection = config.GetSection(</font><span style="color: "><font style="font-size: 12pt" color="#a31515">&quot;system.webServer/modules&quot;</font></span><font style="font-size: 12pt">);</font></font></p>
<p><br><font face="Consolas"><font style="font-size: 12pt">                    </font><span style="color: "><font style="font-size: 12pt" color="#2b91af">ConfigurationElementCollection</font></span><font style="font-size: 12pt"> modulesCollection = modulesSection.GetCollection();</font></font></p>
<p><br><font face="Consolas"><font style="font-size: 12pt">                    </font><span style="color: "><font style="font-size: 12pt" color="#2b91af">Console</font></span><font style="font-size: 12pt">.WriteLine(</font><span style="color: "><font style="font-size: 12pt" color="#a31515">&quot;OK&quot;</font></span><font style="font-size: 12pt">);</font></font></p>
<p><br><font face="Consolas"><font style="font-size: 12pt"></font></font></p>
<p><br><font face="Consolas"><font style="font-size: 12pt">                    </font><span style="color: "><font style="font-size: 12pt" color="#2b91af">Console</font></span><font style="font-size: 12pt">.Write(</font><span style="color: "><font style="font-size: 12pt" color="#a31515">&quot;Uninstalling module...&quot;</font></span><font style="font-size: 12pt">);</font></font></p>
<p><br><font face="Consolas"><font style="font-size: 12pt">                    </font><span style="color: "><font style="font-size: 12pt" color="#2b91af">ConfigurationElement</font></span><font style="font-size: 12pt"> element = FindElement(modulesCollection, </font><span style="color: "><font style="font-size: 12pt" color="#a31515">&quot;add&quot;</font></span><font style="font-size: 12pt">, </font><span style="color: "><font style="font-size: 12pt" color="#a31515">&quot;name&quot;</font></span><font style="font-size: 12pt">, moduleName);</font></font></p>
<p><br><font face="Consolas"><font style="font-size: 12pt">                    </font><span style="color: "><font style="font-size: 12pt" color="#0000ff">if</font></span><font style="font-size: 12pt"> (element == </font><span style="color: "><font style="font-size: 12pt" color="#0000ff">null</font></span><font style="font-size: 12pt">) {</font></font></p>
<p><br><font face="Consolas"><font style="font-size: 12pt">                        </font><span style="color: "><font style="font-size: 12pt" color="#2b91af">Console</font></span><font style="font-size: 12pt">.WriteLine(</font><span style="color: "><font style="font-size: 12pt" color="#a31515">&quot;Not found - no work to do&quot;</font></span><font style="font-size: 12pt">);</font></font></p>
<p><br><font face="Consolas"><font style="font-size: 12pt">                        </font><span style="color: "><font style="font-size: 12pt" color="#0000ff">return</font></span><font style="font-size: 12pt">;</font></font></p>
<p><br><font face="Consolas"><font style="font-size: 12pt">                    }</font></font></p>
<p><br><font face="Consolas"><font style="font-size: 12pt">                    modulesCollection.Remove(element);</font></font></p>
<p><br><font face="Consolas"><font style="font-size: 12pt">                    </font><span style="color: "><font style="font-size: 12pt" color="#2b91af">Console</font></span><font style="font-size: 12pt">.WriteLine(</font><span style="color: "><font style="font-size: 12pt" color="#a31515">&quot;OK&quot;</font></span><font style="font-size: 12pt">);</font></font></p>
<p><br><font face="Consolas"><font style="font-size: 12pt"></font></font></p>
<p><br><font face="Consolas"><font style="font-size: 12pt">                    </font><span style="color: "><font style="font-size: 12pt" color="#2b91af">Console</font></span><font style="font-size: 12pt">.Write(</font><span style="color: "><font style="font-size: 12pt" color="#a31515">&quot;Saving changes...&quot;</font></span><font style="font-size: 12pt">);</font></font></p>
<p><br><font face="Consolas"><font style="font-size: 12pt">                    serverManager.CommitChanges();</font></font></p>
<p><br><font face="Consolas"><font style="font-size: 12pt">                    </font><span style="color: "><font style="font-size: 12pt" color="#2b91af">Console</font></span><font style="font-size: 12pt">.WriteLine(</font><span style="color: "><font style="font-size: 12pt" color="#a31515">&quot;OK&quot;</font></span><font style="font-size: 12pt">);</font></font></p>
<p><br><font face="Consolas"><font style="font-size: 12pt">                }</font></font></p>
<p><br><font face="Consolas"><font style="font-size: 12pt">            }</font></font></p>
<p><br><font face="Consolas"><font style="font-size: 12pt">            </font><span style="color: "><font style="font-size: 12pt" color="#0000ff">catch</font></span><font style="font-size: 12pt"> (</font><span style="color: "><font style="font-size: 12pt" color="#2b91af">Exception</font></span><font style="font-size: 12pt"> ex) {</font></font></p>
<p><br><font face="Consolas"><font style="font-size: 12pt">                </font><span style="color: "><font style="font-size: 12pt" color="#2b91af">Console</font></span><font style="font-size: 12pt">.WriteLine(</font><span style="color: "><font style="font-size: 12pt" color="#a31515">&quot;Failed!&quot;</font></span><font style="font-size: 12pt">);</font></font></p>
<p><br><font face="Consolas"><font style="font-size: 12pt">                </font><span style="color: "><font style="font-size: 12pt" color="#2b91af">Console</font></span><font style="font-size: 12pt">.WriteLine(ex.ToString());</font></font></p>
<p><br><font face="Consolas"><font style="font-size: 12pt">            }</font></font></p>
<p><br><font face="Consolas"><font style="font-size: 12pt">        }</font></font></p>
<p><br><font face="Consolas"><font style="font-size: 12pt"></font></font></p>
<p><br><font face="Consolas"><font style="font-size: 12pt">        </font><span style="color: "><font style="font-size: 12pt" color="#008000">// Helper methods</font></span></font></p>
<p><br><font face="Consolas"><font style="font-size: 12pt"></font></font></p>
<p><br><font face="Consolas"><font style="font-size: 12pt">        </font><span style="color: "><font style="font-size: 12pt" color="#0000ff">private</font></span><font style="font-size: 12pt"> </font><span style="color: "><font style="font-size: 12pt" color="#0000ff">static</font></span><font style="font-size: 12pt"> </font><span style="color: "><font style="font-size: 12pt" color="#2b91af">ConfigurationElement</font></span><font style="font-size: 12pt"> FindElement(</font><span style="color: "><font style="font-size: 12pt" color="#2b91af">ConfigurationElementCollection</font></span><font style="font-size: 12pt"> collection, </font><span style="color: "><font style="font-size: 12pt" color="#0000ff">string</font></span><font style="font-size: 12pt"> elementTagName, </font><span style="color: "><font style="font-size: 12pt" color="#0000ff">params</font></span><font style="font-size: 12pt"> </font><span style="color: "><font style="font-size: 12pt" color="#0000ff">string</font></span><font style="font-size: 12pt">[] keyValues) {</font></font></p>
<p><br><font face="Consolas"><font style="font-size: 12pt">            </font><span style="color: "><font style="font-size: 12pt" color="#0000ff">foreach</font></span><font style="font-size: 12pt"> (</font><span style="color: "><font style="font-size: 12pt" color="#2b91af">ConfigurationElement</font></span><font style="font-size: 12pt"> element </font><span style="color: "><font style="font-size: 12pt" color="#0000ff">in</font></span><font style="font-size: 12pt"> collection) {</font></font></p>
<p><br><font face="Consolas"><font style="font-size: 12pt">                </font><span style="color: "><font style="font-size: 12pt" color="#0000ff">if</font></span><font style="font-size: 12pt"> (</font><span style="color: "><font style="font-size: 12pt" color="#2b91af">String</font></span><font style="font-size: 12pt">.Equals(element.ElementTagName, elementTagName, </font><span style="color: "><font style="font-size: 12pt" color="#2b91af">StringComparison</font></span><font style="font-size: 12pt">.OrdinalIgnoreCase)) {</font></font></p>
<p><br><font face="Consolas"><font style="font-size: 12pt">                    </font><span style="color: "><font style="font-size: 12pt" color="#0000ff">bool</font></span><font style="font-size: 12pt"> matches = </font><span style="color: "><font style="font-size: 12pt" color="#0000ff">true</font></span><font style="font-size: 12pt">;</font></font></p>
<p><br><font face="Consolas"><font style="font-size: 12pt"></font></font></p>
<p><br><font face="Consolas"><font style="font-size: 12pt">                    </font><span style="color: "><font style="font-size: 12pt" color="#0000ff">for</font></span><font style="font-size: 12pt"> (</font><span style="color: "><font style="font-size: 12pt" color="#0000ff">int</font></span><font style="font-size: 12pt"> i = 0; i &lt; keyValues.Length; i += 2) {</font></font></p>
<p><br><font face="Consolas"><font style="font-size: 12pt">                        </font><span style="color: "><font style="font-size: 12pt" color="#0000ff">object</font></span><font style="font-size: 12pt"> o = element.GetAttributeValue(keyValues[i]);</font></font></p>
<p><br><font face="Consolas"><font style="font-size: 12pt">                        </font><span style="color: "><font style="font-size: 12pt" color="#0000ff">string</font></span><font style="font-size: 12pt"> value = </font><span style="color: "><font style="font-size: 12pt" color="#0000ff">null</font></span><font style="font-size: 12pt">;</font></font></p>
<p><br><font face="Consolas"><font style="font-size: 12pt">                        </font><span style="color: "><font style="font-size: 12pt" color="#0000ff">if</font></span><font style="font-size: 12pt"> (o != </font><span style="color: "><font style="font-size: 12pt" color="#0000ff">null</font></span><font style="font-size: 12pt">) {</font></font></p>
<p><br><font face="Consolas"><font style="font-size: 12pt">                            value = o.ToString();</font></font></p>
<p><br><font face="Consolas"><font style="font-size: 12pt">                        }</font></font></p>
<p><br><font face="Consolas"><font style="font-size: 12pt"></font></font></p>
<p><br><font face="Consolas"><font style="font-size: 12pt">                        </font><span style="color: "><font style="font-size: 12pt" color="#0000ff">if</font></span><font style="font-size: 12pt"> (!</font><span style="color: "><font style="font-size: 12pt" color="#2b91af">String</font></span><font style="font-size: 12pt">.Equals(value, keyValues[i + 1], </font><span style="color: "><font style="font-size: 12pt" color="#2b91af">StringComparison</font></span><font style="font-size: 12pt">.OrdinalIgnoreCase)) {</font></font></p>
<p><br><font face="Consolas"><font style="font-size: 12pt">                            matches = </font><span style="color: "><font style="font-size: 12pt" color="#0000ff">false</font></span><font style="font-size: 12pt">;</font></font></p>
<p><br><font face="Consolas"><font style="font-size: 12pt">                            </font><span style="color: "><font style="font-size: 12pt" color="#0000ff">break</font></span><font style="font-size: 12pt">;</font></font></p>
<p><br><font face="Consolas"><font style="font-size: 12pt">                        }</font></font></p>
<p><br><font face="Consolas"><font style="font-size: 12pt">                    }</font></font></p>
<p><br><font face="Consolas"><font style="font-size: 12pt">                    </font><span style="color: "><font style="font-size: 12pt" color="#0000ff">if</font></span><font style="font-size: 12pt"> (matches) {</font></font></p>
<p><br><font face="Consolas"><font style="font-size: 12pt">                        </font><span style="color: "><font style="font-size: 12pt" color="#0000ff">return</font></span><font style="font-size: 12pt"> element;</font></font></p>
<p><br><font face="Consolas"><font style="font-size: 12pt">                    }</font></font></p>
<p><br><font face="Consolas"><font style="font-size: 12pt">                }</font></font></p>
<p><br><font face="Consolas"><font style="font-size: 12pt">            }</font></font></p>
<p><br><font face="Consolas"><font style="font-size: 12pt">            </font><span style="color: "><font style="font-size: 12pt" color="#0000ff">return</font></span><font style="font-size: 12pt"> </font><span style="color: "><font style="font-size: 12pt" color="#0000ff">null</font></span><font style="font-size: 12pt">;</font></font></p>
<p><br><font face="Consolas"><font style="font-size: 12pt">        }</font></font></p>
<p><br><font face="Consolas"><font style="font-size: 12pt"></font></font></p>
<p><br><font face="Consolas"><font style="font-size: 12pt">    }</font></font></p>
<p><br><font face="Consolas"><font style="font-size: 12pt">}</font></font> </p></p>
<h2>Vestavěné instalátory</h2>
<p>Výše uvedené instalátory jsou vcelku univerzální a můžete je snadno níže popsaným způsobem použít ve svých aplikacích. Součástí .NET Frameworku jsou již některé hotové instalátory:</p>
<ul>
  <li><a href="http://msdn.microsoft.com/en-us/library/system.diagnostics.eventloginstaller.aspx">System.Diagnostics.EventLogInstaller</a> – vytváří nový protokol událostí (event log), případně nový zdroj (source) pro existující log. </li>
  <li><a href="http://msdn.microsoft.com/en-us/library/system.diagnostics.performancecounterinstaller.aspx">System.Diagnostics.PerformanceCounterInstaller</a>&#160; – vytváří performance countery (pro sledování výkonu a vytížení serveru) </li>
  <li><a href="http://msdn.microsoft.com/en-us/library/system.messaging.messagequeueinstaller.aspx">System.Messaging.MessageQueueInstaller</a> – vytváří novou frontu v rámci Message Queuing Sevice </li>
  <li><a href="http://msdn.microsoft.com/en-us/library/system.serviceprocess.serviceinstaller.aspx">System.ServiceProcess.ServiceInstaller</a> – slouží k instalaci služby (Windows Service) </li>
  <li><a href="http://msdn.microsoft.com/en-us/library/system.serviceprocess.serviceprocessinstaller.aspx">System.ServiceProcess.ServiceProcessInstaller</a> – slouží k instalaci procesu, který může hostovat několik služeb </li>
</ul>
<h2>Spouštění instalátorů</h2>
<p><em>InstallUtil.exe</em> spustí jenom ty instalátory, jejichž třídy jsou označené atributem <em>[RunInstaller(true)]</em>. Pokud byste ve své aplikaci měli jenom instalátory vlastní výroby, s parametry napsanými přímo v kódu, mohli byste je prostě označit všechny. V praxi to není příliš dobrý nápad, už jenom proto, že činí znovupoužitelnost instalačních tříd dost komplikovanou.</p>
<p>Instalační třídy mohou fungovat hierarchicky. Třída <em>Installer</em> má kolekci <em>Installers</em>, která může obsahovat další instalátory, které se spustí, je-li spuštěn jejich mateřský. V praxi se tedy obvykle postupuje tak, že si v aplikaci vytvoříte jednu třídu, obvykle ji nazývám <em>ApplicationInstaller</em> a v jejím konstruktoru naplníte kolekci <em>Installers</em> všemi dalšími instalátory, které chcete spustit, přičemž jim při této příležitosti také předáte potřebné parametry. Pouze tuto jedinou třídu pak označíte jako <em>[RunInstaller(true)]</em>.</p>
<p>Následující kód ukazuje takovou třídu, která aktivuje oba dva výše popsané instalátory a jeden vestavěný, pro vytvoření vlastního event logu:</p>
<pre style="margin-top: auto; font-family: ; margin-bottom: auto"><font face="Consolas"><span style="color: "><font style="font-size: 12pt" color="#0000ff">using</font></span><font style="font-size: 12pt"> System.ComponentModel;</font></font><br><font face="Consolas"><font style="font-size: 12pt"> </font></font><br><font face="Consolas"><span style="color: "><font style="font-size: 12pt" color="#0000ff">namespace</font></span><font style="font-size: 12pt"> Altairis.Web.OracleBugFix.Install {</font></font><br><font face="Consolas"><font style="font-size: 12pt">&#160;&#160;&#160; [</font><span style="color: "><font style="font-size: 12pt" color="#2b91af">RunInstaller</font></span><font style="font-size: 12pt">(</font><span style="color: "><font style="font-size: 12pt" color="#0000ff">true</font></span><font style="font-size: 12pt">)]</font></font><br><font face="Consolas"><font style="font-size: 12pt">&#160;&#160;&#160; </font><span style="color: "><font style="font-size: 12pt" color="#0000ff">public</font></span><font style="font-size: 12pt">&#160;</font><span style="color: "><font style="font-size: 12pt" color="#0000ff">class</font></span><font style="font-size: 12pt">&#160;</font><span style="color: "><font style="font-size: 12pt" color="#2b91af">ApplicationInstaller</font></span><font style="font-size: 12pt"> : System.Configuration.Install.</font><span style="color: "><font style="font-size: 12pt" color="#2b91af">Installer</font></span><font style="font-size: 12pt"> {</font></font><br><font face="Consolas"><font style="font-size: 12pt"> </font></font><br><font face="Consolas"><font style="font-size: 12pt">&#160;&#160;&#160;&#160;&#160;&#160;&#160; </font><span style="color: "><font style="font-size: 12pt" color="#0000ff">public</font></span><font style="font-size: 12pt"> ApplicationInstaller() {</font></font><br><font face="Consolas"><font style="font-size: 12pt">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </font><span style="color: "><font style="font-size: 12pt" color="#008000">// Add AssemblyGacInstaller</font></span></font><br><font face="Consolas"><font style="font-size: 12pt">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </font><span style="color: "><font style="font-size: 12pt" color="#0000ff">this</font></span><font style="font-size: 12pt">.Installers.Add(</font><span style="color: "><font style="font-size: 12pt" color="#0000ff">new</font></span><font style="font-size: 12pt">&#160;</font><span style="color: "><font style="font-size: 12pt" color="#2b91af">AssemblyGacInstaller</font></span><font style="font-size: 12pt">());</font></font><br><font face="Consolas"><font style="font-size: 12pt"> </font></font><br><font face="Consolas"><font style="font-size: 12pt">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </font><span style="color: "><font style="font-size: 12pt" color="#008000">// Add HttpModuleInstaller</font></span></font><br><font face="Consolas"><font style="font-size: 12pt">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </font><span style="color: "><font style="font-size: 12pt" color="#0000ff">this</font></span><font style="font-size: 12pt">.Installers.Add(</font><span style="color: "><font style="font-size: 12pt" color="#0000ff">new</font></span><font style="font-size: 12pt">&#160;</font><span style="color: "><font style="font-size: 12pt" color="#2b91af">HttpModuleInstaller</font></span><font style="font-size: 12pt"> {</font></font><br><font face="Consolas"><font style="font-size: 12pt">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; ModuleName = </font><span style="color: "><font style="font-size: 12pt" color="#a31515">&quot;AltairisOracleBugFixErrorHandlingModule&quot;</font></span><font style="font-size: 12pt">,</font></font><br><font face="Consolas"><font style="font-size: 12pt">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; ModuleType = </font><span style="color: "><font style="font-size: 12pt" color="#0000ff">typeof</font></span><font style="font-size: 12pt">(</font><span style="color: "><font style="font-size: 12pt" color="#2b91af">ErrorHandlingModule</font></span><font style="font-size: 12pt">),</font></font><br><font face="Consolas"><font style="font-size: 12pt">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; });</font></font><br><font face="Consolas"><font style="font-size: 12pt"> </font></font><br><font face="Consolas"><font style="font-size: 12pt">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </font><span style="color: "><font style="font-size: 12pt" color="#008000">// Add built-in event log installer</font></span></font><br><font face="Consolas"><font style="font-size: 12pt">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </font><span style="color: "><font style="font-size: 12pt" color="#0000ff">this</font></span><font style="font-size: 12pt">.Installers.Add(</font><span style="color: "><font style="font-size: 12pt" color="#0000ff">new</font></span><font style="font-size: 12pt"> System.Diagnostics.</font><span style="color: "><font style="font-size: 12pt" color="#2b91af">EventLogInstaller</font></span><font style="font-size: 12pt"> {</font></font><br><font face="Consolas"><font style="font-size: 12pt">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; Log = </font><span style="color: "><font style="font-size: 12pt" color="#a31515">&quot;MujLog&quot;</font></span><font style="font-size: 12pt">,</font></font><br><font face="Consolas"><font style="font-size: 12pt">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; Source = </font><span style="color: "><font style="font-size: 12pt" color="#a31515">&quot;MujSource&quot;</font></span></font><br><font face="Consolas"><font style="font-size: 12pt">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; });</font></font><br><font face="Consolas"><font style="font-size: 12pt">&#160;&#160;&#160;&#160;&#160;&#160;&#160; }</font></font><br><font face="Consolas"><font style="font-size: 12pt"> </font></font><br><font face="Consolas"><font style="font-size: 12pt">&#160;&#160;&#160; }</font></font><br><font face="Consolas"><font style="font-size: 12pt">}</font></font></pre>

      </section>
      <section class="issues">
        <header>
          <i class="fab fa-github">​</i> Je v článku něco špatně? Chcete něco doplnit?</header>
        <p>Komentáře zde nenajdete, ale pokud je v článku chyba nebo k němu chcete něco věcného doplnit, můžete na GitHubu <a href="https://github.com/ridercz/Blog/issues/new?title=InstallUtil.exe+%e2%80%93+instala%c4%8dn%c3%ad+a+odinstala%c4%8dn%c3%ad+procedury&amp;body=https://www.altair.blog/2010/09/installutil-exe-instalacni-a-odinstalacni-procedury">otevřít nový issue</a> nebo <a href="https://github.com/ridercz/Blog/edit/master/source/2010/09/installutil-exe-instalacni-a-odinstalacni-procedury.md">navrhnout změnu v textu</a> a poslat mi pull request.</p>
        <p>Tamtéž také najdete <a href="https://github.com/ridercz/Blog/commits/master/source/2010/09/installutil-exe-instalacni-a-odinstalacni-procedury.md">historii všech verzí článku</a>, pokud v něm byly provedeny nějaké změny či úpravy.</p>
      </section>
      <section class="sharing">
        <span>Pošli to dál:</span>
        <ul>
          <li>
            <a href="https://twitter.com/intent/tweet?text=https://www.altair.blog/2010/09/installutil-exe-instalacni-a-odinstalacni-procedury">
              <i class="fab fa-twitter">​</i>
            </a>
          </li>
          <li>
            <a href="https://www.facebook.com/sharer.php?u=https://www.altair.blog/2010/09/installutil-exe-instalacni-a-odinstalacni-procedury">
              <i class="fab fa-facebook-f">​</i>
            </a>
          </li>
        </ul>
      </section>
    </main>
    <footer>
      <ul class="logos">
        <li>
          <img src="/content/images/logo_onwhite.svg" alt="altair.blog" style="height:38px;" />
        </li>
      </ul>
      <ul class="text">
        <li>
          Copyright © <a href="https://www.rider.cz/">Michal Altair Valášek</a>, 2003-2019</li>
        <li>
          Powered by <a href="https://www.xml4web.com/">XML4web</a> on <a href="https://www.github.com/">GitHub Pages</a></li>
        <li>
          <i class="fal fa-rss">​</i> RSS: <a href="/feed.rss">všechno</a> | <a href="/feed-internal.rss">místní</a> | <a href="/feed-external.rss">odkazy</a></li>
      </ul>
    </footer>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.15.6/highlight.min.js" integrity="sha256-aYTdUrn6Ow1DDgh5JTc3aDGnnju48y/1c8s1dgkYPQ8=" crossorigin="anonymous">//</script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.15.6/languages/cs.min.js" integrity="sha256-FA/nNCvKfGdhdbNDRy0q50kSiee+lwHIHXpu0PTD3E0=" crossorigin="anonymous">//</script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.15.6/languages/dos.min.js" integrity="sha256-2rzI2inyZTuqpt3ZQtgN0ezM8PgkMQLlVCaHshqVLe4=" crossorigin="anonymous">//</script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.15.6/languages/markdown.min.js" integrity="sha256-rKw1H9B1GnccvcVdRBfRB6EZt3jaXLLbeEWSSEKmtgg=" crossorigin="anonymous">//</script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.15.6/languages/openscad.min.js" integrity="sha256-Y9GkiAmfiOzodbzy8YHB98RiHtWi5AtEgzxr9k0S5jg=" crossorigin="anonymous">//</script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.15.6/languages/powershell.min.js" integrity="sha256-YKxCyo85JjNZ2Dwsj9CUsCPcUemLxwMnUJGAn2PXJU8=" crossorigin="anonymous">//</script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.15.6/languages/scss.min.js" integrity="sha256-eek2X9CXZFSN3jZUYGcxdvpGUbEjjtXobLOI8/qxZqk=" crossorigin="anonymous">//</script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.15.6/languages/xml.min.js" integrity="sha256-LOa0DHufGN2pVUzWMDfCHhttYdt0S7KcTB98p7Rv2k4=" crossorigin="anonymous">//</script>
    <script type="text/javascript">
                  hljs.initHighlightingOnLoad();
              </script>
  </body>
</html>