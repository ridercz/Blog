<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Projekt Atropa (6): Vytváříme captive portal | ALTAIR.blog</title>
    <meta name="viewport" content="width=device-width,minimum-scale=1,initial-scale=1" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <meta http-equiv="Content-Language" content="cs-CZ" />
    <link rel="canonical" href="https://www.altair.blog/2015/08/projekt-atropa-6-vytvarime-captive-portal" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/firacode/6.2.0/fira_code.min.css" integrity="sha512-MbysAYimH1hH2xYzkkMHB6MqxBqfP0megxsCLknbYqHVwXTCg9IqHbk+ZP/vnhO8UEW6PaXAkKe2vQ+SWACxxA==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <link rel="stylesheet" type="text/css" href="/content/styles.min.css?sha=86D6BE2BECADA8998ACB7999F797DEF1103C76B2" />
    <link rel="stylesheet" type="text/css" href="/content/fa-6.5.1/css/all.min.css" />
    <link rel="alternate" type="application/rss+xml" href="https://www.altair.blog/feed.rss" title="RSS (všechny články)" />
    <link rel="alternate" type="application/rss+xml" href="https://www.altair.blog/feed-internal.rss" title="RSS (pouze místní články)" />
    <link rel="alternate" type="application/rss+xml" href="https://www.altair.blog/feed-external.rss" title="RSS (pouze odkazy)" />
    <link rel="shortcut icon" href="https://www.altair.blog/favicon.ico" />
    <link rel="icon" href="https://www.altair.blog/favicon.ico" />
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:site" content="@ridercz" />
    <meta name="twitter:title" content="Projekt Atropa (6): Vytváříme captive portal" />
    <meta name="twitter:description" content="V šestém dílu seriálu o vytvoření &quot;zlé maliny&quot; pro útoky sociálním inženýrstvím si ukážeme, jak vytvořit webovou aplikaci, která se bude tvářit jako autentizační captive portál a pokusí se z uživatelů vylákat přihlašovací údaje k populárním službám. Použijeme přitom ASP.NET 5 a MVC 6." />
    <meta name="twitter:image" content="https://www.altair.blog/content/images/preview-1200.jpg" />
    <meta property="article:published_time" content="2015-08-24T00:00:00+02:00" />
    <meta property="og:type" content="article" />
    <meta property="og:site_name" content="ALTAIR.blog" />
    <meta name="author" content="Michal Altair Valášek" />
    <meta name="title" property="og:title" content="Projekt Atropa (6): Vytváříme captive portal" />
    <meta name="description" property="og:description" content="V šestém dílu seriálu o vytvoření &quot;zlé maliny&quot; pro útoky sociálním inženýrstvím si ukážeme, jak vytvořit webovou aplikaci, která se bude tvářit jako autentizační captive portál a pokusí se z uživatelů vylákat přihlašovací údaje k populárním službám. Použijeme přitom ASP.NET 5 a MVC 6." />
    <meta name="image" property="og:image" content="https://www.altair.blog/content/images/preview-1200.jpg" />
    <meta property="og:locale" content="cs_CZ" />
    <meta property="og:url" content="https://www.altair.blog/2015/08/projekt-atropa-6-vytvarime-captive-portal" />
    <script>
      (function(f, a, t, h, o, m){
        a[h]=a[h]||function(){
          (a[h].q=a[h].q||[]).push(arguments)
        };
        o=f.createElement('script'),
        m=f.getElementsByTagName('script')[0];
        o.async=1; o.src=t; o.id='fathom-script';
        m.parentNode.insertBefore(o,m)
      })(document, window, '//stats.altair.blog/tracker.js', 'fathom');
      fathom('set', 'siteId', 'OBOTR');
      fathom('trackPageview');
    </script>
    <script src="/content/scripts/autocorrect.js?sha=3D24FB150C3151FFF3B9BFCA112E1A8B2F32B377" defer="defer" onload="typo.runAutoCorrector({number: false})">//</script>
    <meta name="robots" content="index, follow" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.4.0/styles/default.min.css" integrity="sha512-hasIneQUHlh06VNBe7f6ZcHmeRTLIaQWFd43YriJ0UND19bvYRauxthDg8E4eVNPm9bRUhr5JGeqH7FRFXQu5g==" crossorigin="anonymous" referrerpolicy="no-referrer" />
  </head>
  <body>
    <header>
      <div>
        <a href="/">
          <img src="/content/images/logo_onblack.svg" alt="altair.blog" style="max-height:100px;max-width:80%" />
        </a>
      </div>
    </header>
    <nav>
      <ul>
        <li>
          <a href="https://www.rider.cz/" title="Autor: Michal Altair Valášek">
            <i class="fal fa-fw fa-user"> </i>
          </a>
        </li>
        <li>
          <a href="/archive" title="Archiv článků">
            <i class="fal fa-fw fa-archive"> </i>
          </a>
        </li>
        <li>
          <a href="/categories" title="Rubriky">
            <i class="fal fa-fw fa-tags"> </i>
          </a>
        </li>
        <li>
          <a href="/serials" title="Seriály">
            <i class="fal fa-fw fa-list-alt"> </i>
          </a>
        </li>
        <li>
          <a href="/search" title="Vyhledávání">
            <i class="fal fa-fw fa-search"> </i>
          </a>
        </li>
        <li>
          <a href="https://www.rider.cz/#contact" title="Kontakt">
            <i class="fal fa-fw fa-envelope"> </i>
          </a>
        </li>
        <li>
          <a href="https://facebook.com/rider.cz" title="Facebook">
            <i class="fab fa-fw fa-facebook"> </i>
          </a>
        </li>
        <li>
          <a href="https://twitter.com/ridercz" title="Twitter">
            <i class="fab fa-twitter"> </i>
          </a>
        </li>
        <li>
          <a href="https://github.com/ridercz" title="Github">
            <i class="fab fa-fw fa-github"> </i>
          </a>
        </li>
        <li>
          <a href="https://ask.fm/ridercz" title="Ask.fm">
            <i class="fal fa-fw fa-question"> </i>
          </a>
        </li>
      </ul>
    </nav>
    <main>
      <h1>Projekt Atropa (6): Vytváříme captive portal</h1>
      <aside class="article-info">
        <ul class="categories">
          <li>
            <a href="/categories/bezpecnost" title="Rubrika">
              <i class="fal fa-tag"> </i>Bezpečnost</a>
          </li>
        </ul>
        <ul class="serials">
          <li>
            <a href="/serials/projekt-atropa" title="Seriál">
              <i class="fal fa-list-alt"> </i>Projekt Atropa</a>
          </li>
        </ul>
        <div title="Autor">
          <a href="https://www.rider.cz/">Michal Altair Valášek </a>
          <i class="fal fa-fw fa-user">​</i>
        </div>
        <div title="Datum vydání">
          <time datetime="2015-08-24T00:00:00+02:00">24. srpna 2015 <i class="fal fa-fw fa-calendar-lines">​</i></time>
        </div>
      </aside>
      <section class="article-text">
        <blockquote>
<p><strong>Upozornění:</strong> Tento text je několik let starý a spousta věcí se změnila. Zejména v ASP.NET Core (zde pod starým názvem ASP.NET 5). Článek ponechávám jako referenci, ale obecně doporučuji nalézt novější zdroje, jako napříkad <a href="/serials/asp-net-na-raspberry-pi">tento seriál</a>.</p>
</blockquote>
<p>V šestém dílu seriálu o vytvoření <a href="http://www.aspnet.cz/articles/5429-projekt-atropa-1-jak-vyrobit-z-raspberry-pi-zle-zarizeni-s-netem">&quot;zlé maliny&quot; pro útoky sociálním inženýrstvím</a> si ukážeme, jak vytvořit webovou aplikaci, která se bude tvářit jako autentizační captive portál a pokusí se z uživatelů vylákat přihlašovací údaje k populárním službám. Použijeme přitom ASP.NET 5 a MVC 6. Aplikace je poměrně triviální a nepochybně by téhož výsledku bylo možno dosáhnout i jednoduššími prostředky. Já jsem zvolil ASP.NET 5 a MVC 6, protože jsem chtěl novou platformu vyzkoušet a také zkusit na Linuxu rozběhnout z .NETu trochu víc, než obligátní &quot;Hello World!&quot;.</p>
<h2 id="user-experience">User experience</h2>
<p>Co bude naše aplikace dělat? Pokud se uživatel připojí k otevřenému Wi-Fi hotspotu, každý HTTP požadavek ho přenese na naši aplikaci. Ta mu ukáže úhledný dialog a nabídne, že se může připojit k Internetu, pokud se přihlásí pomocí služeb jako je Facebook, Twitter, Google Account, Microsoft Account nebo místní Seznam.cz:</p>
<p><a href="https://www.cdn.altairis.cz/Blog/2015/20150823-atropa-gate-step0_2.png"><img src="https://www.cdn.altairis.cz/Blog/2015/20150823-atropa-gate-step0_thumb.png" alt="atropa-gate-step0" title="atropa-gate-step0" /></a></p>
<p>Seznam služeb je konfigurovatelný, pro změny stačí editovat soubor <code>config.json</code> a přidat správně pojmenovaný soubor s obrázkem. Poté, co uživatel klepnutím vybere službu, zobrazí se mu přihlašovací dialog a bude vyzván k zadání jména nebo hesla pro příslušnou službu:</p>
<p><a href="https://www.cdn.altairis.cz/Blog/2015/20150823-atropa-gate-step1_2.png"><img src="https://www.cdn.altairis.cz/Blog/2015/20150823-atropa-gate-step1_thumb.png" alt="atropa-gate-step1" title="atropa-gate-step1" /></a></p>
<p>Bez ohledu na to, jaké heslo zadá, bude mu po odeslání zobrazena následující chybová stránka:</p>
<p><a href="https://www.cdn.altairis.cz/Blog/2015/20150823-atropa-gate-step2_4.png"><img src="https://www.cdn.altairis.cz/Blog/2015/20150823-atropa-gate-step2_thumb_1.png" alt="atropa-gate-step2" title="atropa-gate-step2" /></a></p>
<p>Vše vypadá podle mého názoru velice elegantně a profesionálně. Upřímně řečeno, aplikace je minimálně po vizuální stránce a po stránce podpory pro mobilní zařízení napsána lépe, než většina skutečných přihlašovacích portálů.</p>
<p>Na rozdíl od nich však uživateli Internet nezpřístupní, jenom zaznamená zadané jméno a heslo do obyčejného textového souboru.</p>
<h2 id="konfigurace-aplikace">Konfigurace aplikace</h2>
<p>Aplikace je napsána v ASP.NET 5 a MVC 6, ve Visual Studiu 2015. Je velice jednoduchá, obsahuje jeden controller se čtyřmi akcemi, tři pohledy a celý jeden model. Zdrojové kódy <a href="https://github.com/ridercz/WifiGate/">najdete na GitHubu</a>. K dispozici jsou dva releasy. Verze <a href="https://github.com/ridercz/WifiGate/releases/tag/v1.0.0-alpha">1.0.0-alpha</a> je naprosto minimální implementace, kde je všechno zapsáno natvrdo a aplikace nemá žádnou grafiku, která by stála za řeč. <a href="https://github.com/ridercz/WifiGate/releases/tag/v1.0.0">Verze 1.0.0</a> už je kompletní aplikace s konfigurací a grafikou.</p>
<p>Klíčovou součástí aplikace je její konfigurace, neboť ta říká, co se vlastně bude dělat. Využívám zde nový konfigurační systém v ASP.NET 5, který je vymyšlený docela dobře, ale zato je mizerně popsaný. Jeho fungování věnuji samostatný článek, zde je jednom návod k použití. Aplikaci řídí soubor <code>config.json</code>, který ve výchozím nastavení vypadá takto:</p>
<pre><code>{
    &quot;ForceHostName&quot;: &quot;www.wifigate-login.local&quot;,
    &quot;OutputFileName&quot;: &quot;wwwroot/passwords.txt&quot;,
    &quot;MaximumPasswordLength&quot;: 4,
    &quot;IdentityProviders&quot;: [
        {
            &quot;Id&quot;: &quot;facebook&quot;,
            &quot;Title&quot;: &quot;Facebook&quot;
        },
        {
            &quot;Id&quot;: &quot;google&quot;,
            &quot;Title&quot;: &quot;Google Account&quot;
        },
        {
            &quot;Id&quot;: &quot;twitter&quot;,
            &quot;Title&quot;: &quot;Twitter&quot;
        },
        {
            &quot;Id&quot;: &quot;microsoft&quot;,
            &quot;Title&quot;: &quot;Microsoft Account&quot;
        },
        {
            &quot;Id&quot;: &quot;seznam&quot;,
            &quot;Title&quot;: &quot;Seznam.cz&quot;
        }
    ]
}
</code></pre>
<p>Význam konfiguračních hodnot je následující:</p>
<ul>
<li><code>ForceHostName</code> je název serveru, na který bude uživatel přesměrován poté, co se na aplikaci dostane. Účelem je zvýšit důvěryhodnost rozhraní, neboť takto autorizační portály obvykle postupují. Můžete sem zadat jakoukoliv adresu - existující, neexistující, dokonce i s vymyšlenou top-level doménou. Nebo - jako já - můžete použít standardizovanou doménu &quot;<code>.local</code>&quot; pro lokální sítě. Po <a href="http://www.aspnet.cz/articles/5435-projekt-atropa-5-vytvarime-honeypot">konfiguraci popsané v předchozím dílu</a> bude stejně jakýkoliv DNS dotaz resolvován na adresu našeho honeypotu. Tento parametr je nepovinný, pokud bude hodnota prázdná nebo nebude přítomna vůbec, přesměrování se neprovede. Také se neprovede, pokud aplikace běží ve vývojovém prostředí.</li>
<li><code>OutputFileName</code> je název výsledného souboru, kam se budou ukládat ulovená hesla. Adresa je relativní k rootu aplikace. V uvedeném příkladu se budou data ukládat do souboru, který bude dostupný na adrese <code>http://adresa-honeypotu/passwords.txt</code>.</li>
<li><code>MaximumPasswordLength</code> je počet znaků z hesla, které se budou ukládat. Vzhledem k tomu, že celou aplikaci hodlám používat pro výukové účely a výsledek její činnosti uživatelům online ukazovat, nechci skladovat celá hesla. Ukládat se bude jenom prvních několik znaků (zde čtyři), zbytek hesla bude nahrazen hvězdičkami.</li>
<li><code>IdentityProviders</code> je seznam služeb, přes které chceme povolit přihlašování (jejichž přihlašovací údaje chceme získat). Pro každou z nich určujeme její <code>Id</code> a <code>Název</code> (<code>Title</code>). Parametr <code>Id</code> bude součástí URL a také se použije jako název obrázku s logem. Mělo by se tedy jednat o &quot;bezpečný&quot; string, který lze použít jako název souboru a cesty. <code>Title</code> je lidsky čitelný název služby. Identity providerů může být neomezené množství, já jsem zvolil čtyři nejpopupárnější služby plus lokálního favorita Seznam.cz.</li>
</ul>
<h2 id="jak-aplikace-funguje">Jak aplikace funguje?</h2>
<p>O tvorbě aplikací v ASP.NET 5 napíšu podrobnější článek někdy jindy, zde jenom stručně:</p>
<ul>
<li><code>project.json</code> je extrémně důležitý, protože drží celou aplikaci pohromadě. Dí se říct, že je křížencem souborů <code>.csproj</code> a <code>packages.config</code> z předchozích verzí. Obsahuje seznam NuGet balíčků a také instrukce pro build. Můj soubor je víceméně ve výchozím stavu, přidal jsem jenom podporu pro Kestrel, který budeme potřebovat pro běh na Linuxu.</li>
<li><code>Startup.cs</code> je Owin Startup Class. Kód v něm se spouští jako první při startu aplikace a celou ji inicializuje. Je jakýmsi křížencem souborů <code>Global.asax</code> a <code>web.config</code> v předchozích verzích. V jeho konstruktoru načítám výše popsanou konfiguraci. V <code>ConfigureServices</code> registruji služby, které se budou později používat pro dependency injection. V Configure pak říkám, jaké OWIN middlewares (ekvivalent HTTP modulů a handlerů ze starších verzí) se budou používat atd.</li>
<li><code>hosting.ini</code> je soubor, který mi tam zbyl z výchozí šablony a upřímně, zatím jsem nevyzkoumal, k čemu je dobrý, musím se na to podívat později.</li>
<li><code>GlobalSuppressions.cs</code> na běh aplikace nemá vliv. Používám ve Visual Studiu 2015 plugin <a href="http://vsrefactoringessentials.com/">Refactoring Essentials</a>, který hlídá dodržování standardů psaní kódu a nabízí refactoring obvyklých porušení. Některá jeho pravidla se mi nelíbí a v tomto souboru se dají na úrovni projektu vypnout.</li>
<li><code>WifiGateOptions.cs</code> je model používaný pro konfiguraci.</li>
</ul>
<p>Ostatní soubory jsou standardní a neliší se podstatně od běžné ASP.NET MVC aplikace.</p>
<h2 id="nasazeni-na-honeypot">Nasazení na honeypot</h2>
<p>Raspberry připravené podle předchozích dílů seriálu připojíme do stejné drátové sítě jako řídící počítač a zapneme. Potřebujeme na něj aplikaci zkopírovat, což lze učinit mnoha způsoby. Já budu používat SCP, což je přenos souborů po SSH. Pokud jste si nainstalovali PuTTY, k čemuž jsem vás vyzýval ve <a href="http://www.aspnet.cz/articles/5430-projekt-atropa-2-zprovozneni-raspberry-pi-a-raspbian-linuxu">druhém dílu</a>, máte k dispozici řádkovou utilitu <code>pscp.exe</code>.</p>
<p>Smažte na Raspberry Pi obsah složky s obsahem web serveru, tedy <code>/home/pi/www/wifigate</code>, ovšem nikoliv složku samotnou. Můžete tak učinit třeba příkazem <code>rm -rf /home/pi/www/wifigate/*</code>.</p>
<p>Poté pomocí <code>pscp.exe</code> nakopírujte zdrojové kódy aplikace WifiGate.  Použijete k tomu následující příkaz, spuštěný ovšem na Windows:</p>
<pre><code>pscp -r -batch -C -pw raspberry &quot;C:\Users\Altair\Source\Repos\WifiGate\src\WifiGate\*&quot; pi@10.7.0.103:/home/pi/www/wifigate
</code></pre>
<p>Význam parametrů je následující:</p>
<ul>
<li><code>-r</code> postupuje rekurzivně, kopíruje i podadresáře.</li>
<li><code>-batch</code> se neptá na přepis souborů.</li>
<li><code>-C</code> použije při přenosu kompresi.</li>
<li><code>-pw raspberry</code> umožňuje specifikovat heslo (v tomto případě <code>raspberry</code>).</li>
<li><code>&quot;C:\Users\...\*&quot;</code> popisuje, které soubory se mají přenášet. Zde všechno ve složce WifiGate; uvozovky jsou nutné, pokud cesta obsahuje mezery.</li>
<li>Posledním parametrem určujete, kam se mají data nakopírovat. Formát je <code>uživatel@host:cesta</code>. Zde se připojuji jako uživatel <code>pi</code> k počítači s adresou <code>10.7.0.103</code> a ukládám do adresáře <code>/home/pi/www/wifigate</code>.</li>
</ul>
<p>Po nakopírování souborů se opět připojte na Raspberry a spusťte obnovu NuGet balíčků příkazem <code>dnu restore /home/pi/www/wifigate</code>.</p>
<p>Nyní raspberry restartujte a počkejte, dokud nenaběhne. Pokud jste vše udělali správně, po restartu začne honeypot vysílat otevřenou síť jménem Internet. Když se k ní připojíte, jakýkoliv HTTP request bude přesměrován na adresu falešného portálu a vyzváni k zadání hesla. Ulovená hesla najdete na adrese brány v souboru <code>passwords.txt</code>.</p>
<p>V dokončení seriálu si ukážeme, jak se útokům tohoto typu bránit z pozice uživatele a z pozice autora serveru.</p>

      </section>
      <section class="issues">
        <header>
          <i class="fab fa-github">​</i> Je v článku něco špatně? Chcete něco doplnit?</header>
        <p>Komentáře zde nenajdete, ale pokud je v článku chyba nebo k němu chcete něco věcného doplnit, můžete na GitHubu <a href="https://github.com/ridercz/Blog/issues/new?title=Projekt+Atropa+(6)%3a+Vytv%c3%a1%c5%99%c3%adme+captive+portal&amp;body=https://www.altair.blog/2015/08/projekt-atropa-6-vytvarime-captive-portal">otevřít nový issue</a> nebo <a href="https://github.com/ridercz/Blog/edit/master/source/2015/08/projekt-atropa-6-vytvarime-captive-portal.md">navrhnout změnu v textu</a> a poslat mi pull request.</p>
        <p>Tamtéž také najdete <a href="https://github.com/ridercz/Blog/commits/master/source/2015/08/projekt-atropa-6-vytvarime-captive-portal.md">historii všech verzí článku</a>, pokud v něm byly provedeny nějaké změny či úpravy.</p>
      </section>
      <section class="sharing">
        <span>Pošli to dál:</span>
        <ul>
          <li>
            <a href="https://twitter.com/intent/tweet?text=https://www.altair.blog/2015/08/projekt-atropa-6-vytvarime-captive-portal">
              <i class="fab fa-x-twitter">​</i>
            </a>
          </li>
          <li>
            <a href="https://www.facebook.com/sharer.php?u=https://www.altair.blog/2015/08/projekt-atropa-6-vytvarime-captive-portal">
              <i class="fab fa-facebook-f">​</i>
            </a>
          </li>
        </ul>
      </section>
    </main>
    <footer>
      <ul class="logos">
        <li>
          <img src="/content/images/logo_onwhite.svg" alt="altair.blog" style="height:38px;" />
        </li>
      </ul>
      <ul class="text">
        <li>
          Copyright © <a href="https://www.rider.cz/">Michal Altair Valášek</a>, 2003-2024</li>
        <li>
          Powered by <a href="https://www.xml4web.com/">XML4web</a> on <a href="https://www.github.com/">GitHub Pages</a></li>
        <li>
          <i class="fal fa-rss">​</i> RSS: <a href="/feed.rss">všechno</a> | <a href="/feed-internal.rss">místní</a> | <a href="/feed-external.rss">odkazy</a></li>
      </ul>
    </footer>
  </body>
</html>