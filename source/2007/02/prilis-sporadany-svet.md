<!-- dcterms:identifier = aspnetcz#142 -->
<!-- dcterms:title = Příliš spořádaný svět -->
<!-- dcterms:abstract = Získat náhodná čísla je mnohem složitější, než jak to na první pohled vypadá. Zejména pokud jich potřebujeme hodně. A to v kryptografii většinou potřebujeme. Tento článek se zabývá tím, jak v .NET získat dostatek čísel, která jsou skutečně náhodná. -->
<!-- np9:categoryId = 2 -->
<!-- x4w:category = Bezpečnost -->
<!-- np9:authorId = 1 -->
<!-- np9:authorEmail = michal.valasek@altairis.cz -->
<!-- dcterms:creator = Michal Altair Valášek -->
<!-- dcterms:created = 2007-02-26T15:16:53.447+01:00 -->
<!-- dcterms:dateAccepted = 2007-02-26T15:16:53.447+01:00 -->

<p>V řadě případů potřebujeme v programu vygenerovat náhodná čísla. Účely se různí, od zobrazení náhodného "tipu dne" přes pohyb protihráče v počítačové hře až po kryptografické operace - šifrování a digitální podepisování.</p><p>Problém spočívá v tom, že získat skutečně náhodná čísla je pouze prostřednictvím běžného digitálního počítače principiálně nemožné. Počítač je z matematického hlediska deterministický konečněstavový automat: na stejnou sadu vstupních parametrů pokaždé vydá tentýž výsledek.</p><p>Běžná náhodná (ve skutečnosti pseudo-náhodná) čísla generovaná v .NETu např. třídou <code>System.Random</code> jsou dobrá možná pro zobrazování oněch tipů, ale pro použití ke generování kryptografických klíčů se nehodí. Jsou v nich patrná schémata, která lze s dostatkem vstupních dat odhalit a bepečnost řady šifrovacích algoritmů závisí na kvalitě klíče.</p><p>Pro opravdu náhodná data je třeba využít speciální hardware, který využívá ke generování chaosu například vyzařování radioaktivního materiálu, atmosferický šum a nebo přechodové jevy na polovodičích. Takové komponenty ale nejsou součástí běžných počítačů.</p><p>Operační systémy proto obvykle obsahují mechanismus, který se snaží získat náhodnost z různých zdrojů, které sice nejsou úplně náhodné, ale jsou dostatečně nepředvídatelné k tomu, aby byly prakticky použitelné. Používají se např. přesně měřené intervaly mezi stisky kláves na klávesnici nebo příchody síťových paketů. V systému pak existuje služba (nazývaná např. <em>entropy gathering daemon</em>), která takto získané aplikace analyzuje, filtruje a používá ke generování náhodných dat.</p><h2>RNGCryptoServiceProvider</h2><p>Přístup k tomuto generátoru je možný pomocí třídy <code>System.Security.Cryptography.RNGCryptoServiceProvider</code>. Ta má dvě metody, které naplní zvolené pole náhodnými daty: <code>GetBytes</code> a <code>GetNonZeroBytes</code>. Obě dělají totéž, až na to, že druhá jmenovaná z náhodného souboru vyřazuje bajty s hodnotou 0, protože v některých aplikacích znak s hodnotou 0 znamená konec hodnot.</p><p>Výsledkem volání těchto hodnot je pole bajtů, použitelné např. jako šifrovací klíč. Obvykle se zapisuje jako hodnota zakódovaná do tisknutelných znaků pomocí Base64 nebo Base16 (šestnáctkové číslice). Příslušný kód v C# může vypadat takto:</p><div style="FONT-SIZE: 11pt; BACKGROUND: white; COLOR: black; FONT-FAMILY: Consolas, Courier New, monospace"><p style="MARGIN: 0px"><span style="COLOR: #0000ff">int</span> keyLength = 24; <span style="COLOR: #008000">// 24 bytes = 192 bits</span></p><p style="MARGIN: 0px"> </p><p style="MARGIN: 0px"><span style="COLOR: #008000">// Generate random bytearray</span></p><p style="MARGIN: 0px"><span style="COLOR: #0000ff">byte</span>[] key = <span style="COLOR: #0000ff">new</span> <span style="COLOR: #0000ff">byte</span>[keyLength];</p><p style="MARGIN: 0px">System.Security.Cryptography.<span style="COLOR: #2b91af">RNGCryptoServiceProvider</span> rng = <span style="COLOR: #0000ff">new</span> System.Security.Cryptography.<span style="COLOR: #2b91af">RNGCryptoServiceProvider</span>();</p><p style="MARGIN: 0px">rng.GetBytes(key);</p><p style="MARGIN: 0px"> </p><p style="MARGIN: 0px"><span style="COLOR: #008000">// Convert key to Base64</span></p><p style="MARGIN: 0px"><span style="COLOR: #0000ff">string</span> enc64 = System.<span style="COLOR: #2b91af">Convert</span>.ToBase64String(key);</p><p style="MARGIN: 0px"> </p><p style="MARGIN: 0px"><span style="COLOR: #008000">// Convert key to Base16</span></p><p style="MARGIN: 0px">System.Text.<span style="COLOR: #2b91af">StringBuilder</span> b16 = <span style="COLOR: #0000ff">new</span> System.Text.<span style="COLOR: #2b91af">StringBuilder</span>(keyLength * 2);</p><p style="MARGIN: 0px"><span style="COLOR: #0000ff">for</span> (<span style="COLOR: #0000ff">int</span> i = 0; i &lt; keyLength; i++) b16.AppendFormat(<span style="COLOR: #a31515">"{0:X2}"</span>, key[i]);</p><p style="MARGIN: 0px"><span style="COLOR: #0000ff">string</span> enc16 = b16.ToString();</p></div><!--EndFragment--><p>Proměnná <strong>keyLength</strong> obsahuje délku klíče v bajtech. v proměnných <strong>enc64</strong> a <strong>enc16</strong> najdete tentýž náhodný klíč, zakódovaný pomocí Base64 a Base16.</p><p>Můžete si stáhnout <a href="https://www.cdn.altairis.cz/Blog/2007/20070226-KeyGen.zip">ukázkovou stránku</a>, která umožňuje generovat náhodné klíče různých délek.</p>