<!-- dcterms:identifier = aspnetcz#264 -->
<!-- dcterms:title = Strašlivé dědictví přípon aneb preCondition "managedHandler" a HTTP moduly -->
<!-- dcterms:abstract = Stručné pojednání o historii významu přípon souborů a jejich vlivu na funkčnost webových aplikací. Pokud se vám po přechodu na IIS 7 aplikace chová nějak divně, možná zde najdete odpověď. -->
<!-- np9:categoryId = 4 -->
<!-- x4w:category = Programování -->
<!-- np9:authorId = 1 -->
<!-- np9:authorEmail = michal.valasek@altairis.cz -->
<!-- dcterms:creator = Michal Altair Valášek -->
<!-- dcterms:created = 2010-04-18T20:30:22.813+02:00 -->
<!-- dcterms:dateAccepted = 2010-04-18T20:30:22.813+02:00 -->

<p>Na počátku byla tma. Pak se zrodil HyperText Transfer Protocol. Mezitím pravda nastala celá řada dalších věcí, ale ty nejsou pro náš příběh příliš podstatné. Podstatné je, co se dělo potom. Webové servery byly úplně původně navrženy spíš jako úložiště dat, než jako aplikační platforma. Na server se uložil soubor, klient si jej vyžádal a server mu ho poslal, aniž se sebeméně zajímal o jeho obsah. Bylo to takové jeddnodušší FTPko.</p>  <p>Základ webových aplikací, tak jak je známe dnes, byl položen teprve ve chvíli, kdy se web server začal zajímat o to, co vlastně posílá. Kdy ho bylo možno zkonfigurovat tak, aby za určitých okolností klientovi neposlal obsah požadovaného souboru, alébrž spustil jakýsi kód a klientovi poslal výsledek. Historicky za tímto účelem existovaly dvě technologie: CGI (Common Gateway Interface) a ISAPI (Internet Server Application Programming Interface). Ač je jejich princip fungování dost odlišný, jedno mají společné: požadavky na ně se typicky mapují pomocí přípon. Podle přípony požadovaného souboru server rozpoznal, co s ním má provést. Soubory s příponou .php se tak poslaly jednomu procesoru, .asp jinému a cokoliv neznámého poslalo beze změny.</p>  <p>Na platformě Microsoft byl tento přístup ortodoxně dodržován Internet Information Services až do verze 6.0. Ve výchozí konfiguraci byly jednotlivé typy aplikačních platforem rozděleny právě pomocí přípon. V zásadě vám nic nebránilo v tom, aby v rámci jednoho virtuálního web serveru vedle sebe běželo například ASP.NET, ASP a PHP. Jednotlivé platformy o požadavcích, které nešly na &quot;jejich&quot; přípony prostě nevěděly.</p>  <p>Pak přišla verze 7.0 se zcela novou architekturou, kterou sice je možné pokládat za ideového nástupce ISAPI extensions, ale ve které na příponách až tak nezáleželo – protože tou dobou se z různých důvodů z přípony stala persona non grata. HTTP moduly, známé už od ASP.NET verze 1.0, najednou dostaly nové pole působnosti: používají se na všechny požadavky, bez ohledu na přípony. </p>  <p>Nové možnosti ale přinesly i nové problémy. Ukážeme si to na příkladu modulů pro Forms Authentication a URL Authorization. Na IIS 6.0 se toto zabezpečení vztahovalo pouze na ASP.NET stránky. I když jste pomocí URL authorization zakázali uživateli přístup, stále mohl číst například obrázky nebo CSS soubory. Pokud byste takovou aplikaci beze změny přenesli na IIS 7, její chování by se změnilo. Autorizační pravidla by se začala vztahovat na všechny soubory a dokud byste nepřihlášeným uživatelům explicitně nepovolili přístup např. ke kaskádovým stylům a obrázkům, zobrazila by se např. přihlašovací stránka bez nich, jinak než bylo původně zamýšleno.</p>  <p>Pročež přišel Microsoft s <code>preCondition</code> zvanou <code>managedHandler</code>. Obecně mechanismus preConditions slouží k natažení správné verze modulu či handleru v závislosti na verzi .NET runtime nebo architektuře procesoru (32/64- bit) a vyhodnocuje se jenom jednou, při spouštění application poolu. Leč <code>managedHandler</code> je výjimkou: vyhodnocuje se při každém požadavku a pokud je přítomen, spustí se pouze v případě, že je požadavek dalším nastavením mapován na handler psaný v managed kódu (což se stále děje typicky pomocí přípon). V zásadě lze tedy pomocí této preCondition emulovat chování předchozích verzí.</p>  <p>Výchozí nastavení je takové, že všechny managed moduly, které jsou součástí .NET Frameworku, mají tuto podmínku nastaveny. Když se podíváte do svého souboru <code>applicationHost.config</code>, najdete tam něco na tento způsob:</p>  <div style="font-family: consolas, &#39;Courier New&#39;, monospace; background: white; color: black; font-size: 13pt">   <p style="margin: 0px"><span style="color: blue">&lt;</span><span style="color: #a31515">system.webServer</span><span style="color: blue">&gt;</span></p>    <p style="margin: 0px"><span style="color: blue">&#160;&#160;&#160; &lt;</span><span style="color: #a31515">modules</span><span style="color: blue">&gt;</span></p>    <p style="margin: 0px"><span style="color: blue">&#160;&#160;&#160;&#160;&#160;&#160;&#160; &lt;</span><span style="color: #a31515">add</span><span style="color: blue"> </span><span style="color: red">name</span><span style="color: blue">=</span>&quot;<span style="color: blue">OutputCache</span>&quot;<span style="color: blue"> </span><span style="color: red">type</span><span style="color: blue">=</span>&quot;<span style="color: blue">System.Web.Caching.OutputCacheModule</span>&quot;<span style="color: blue"> </span><span style="color: red">preCondition</span><span style="color: blue">=</span>&quot;<span style="color: blue">managedHandler</span>&quot;<span style="color: blue"> /&gt;</span></p>    <p style="margin: 0px"><span style="color: blue">&#160;&#160;&#160;&#160;&#160;&#160;&#160; &lt;</span><span style="color: #a31515">add</span><span style="color: blue"> </span><span style="color: red">name</span><span style="color: blue">=</span>&quot;<span style="color: blue">Session</span>&quot;<span style="color: blue"> </span><span style="color: red">type</span><span style="color: blue">=</span>&quot;<span style="color: blue">System.Web.SessionState.SessionStateModule</span>&quot;<span style="color: blue"> </span><span style="color: red">preCondition</span><span style="color: blue">=</span>&quot;<span style="color: blue">managedHandler</span>&quot;<span style="color: blue"> /&gt;</span></p>    <p style="margin: 0px"><span style="color: blue">&#160;&#160;&#160;&#160;&#160;&#160;&#160; &lt;</span><span style="color: #a31515">add</span><span style="color: blue"> </span><span style="color: red">name</span><span style="color: blue">=</span>&quot;<span style="color: blue">WindowsAuthentication</span>&quot;<span style="color: blue"> </span><span style="color: red">type</span><span style="color: blue">=</span>&quot;<span style="color: blue">System.Web.Security.WindowsAuthenticationModule</span>&quot;<span style="color: blue"> </span><span style="color: red">preCondition</span><span style="color: blue">=</span>&quot;<span style="color: blue">managedHandler</span>&quot;<span style="color: blue"> /&gt;</span></p>    <p style="margin: 0px"><span style="color: blue">&#160;&#160;&#160;&#160;&#160;&#160;&#160; &lt;</span><span style="color: #a31515">add</span><span style="color: blue"> </span><span style="color: red">name</span><span style="color: blue">=</span>&quot;<span style="color: blue">FormsAuthentication</span>&quot;<span style="color: blue"> </span><span style="color: red">type</span><span style="color: blue">=</span>&quot;<span style="color: blue">System.Web.Security.FormsAuthenticationModule</span>&quot;<span style="color: blue"> </span><span style="color: red">preCondition</span><span style="color: blue">=</span>&quot;<span style="color: blue">managedHandler</span>&quot;<span style="color: blue"> /&gt;</span></p>    <p style="margin: 0px"><span style="color: blue">&#160;&#160;&#160;&#160;&#160;&#160;&#160; &lt;</span><span style="color: #a31515">add</span><span style="color: blue"> </span><span style="color: red">name</span><span style="color: blue">=</span>&quot;<span style="color: blue">DefaultAuthentication</span>&quot;<span style="color: blue"> </span><span style="color: red">type</span><span style="color: blue">=</span>&quot;<span style="color: blue">System.Web.Security.DefaultAuthenticationModule</span>&quot;<span style="color: blue"> </span><span style="color: red">preCondition</span><span style="color: blue">=</span>&quot;<span style="color: blue">managedHandler</span>&quot;<span style="color: blue"> /&gt;</span></p>    <p style="margin: 0px"><span style="color: blue">&#160;&#160;&#160;&#160;&#160;&#160;&#160; &lt;</span><span style="color: #a31515">add</span><span style="color: blue"> </span><span style="color: red">name</span><span style="color: blue">=</span>&quot;<span style="color: blue">RoleManager</span>&quot;<span style="color: blue"> </span><span style="color: red">type</span><span style="color: blue">=</span>&quot;<span style="color: blue">System.Web.Security.RoleManagerModule</span>&quot;<span style="color: blue"> </span><span style="color: red">preCondition</span><span style="color: blue">=</span>&quot;<span style="color: blue">managedHandler</span>&quot;<span style="color: blue"> /&gt;</span></p>    <p style="margin: 0px"><span style="color: blue">&#160;&#160;&#160;&#160;&#160;&#160;&#160; &lt;</span><span style="color: #a31515">add</span><span style="color: blue"> </span><span style="color: red">name</span><span style="color: blue">=</span>&quot;<span style="color: blue">UrlAuthorization</span>&quot;<span style="color: blue"> </span><span style="color: red">type</span><span style="color: blue">=</span>&quot;<span style="color: blue">System.Web.Security.UrlAuthorizationModule</span>&quot;<span style="color: blue"> </span><span style="color: red">preCondition</span><span style="color: blue">=</span>&quot;<span style="color: blue">managedHandler</span>&quot;<span style="color: blue"> /&gt;</span></p>    <p style="margin: 0px"><span style="color: blue">&#160;&#160;&#160;&#160;&#160;&#160;&#160; &lt;</span><span style="color: #a31515">add</span><span style="color: blue"> </span><span style="color: red">name</span><span style="color: blue">=</span>&quot;<span style="color: blue">FileAuthorization</span>&quot;<span style="color: blue"> </span><span style="color: red">type</span><span style="color: blue">=</span>&quot;<span style="color: blue">System.Web.Security.FileAuthorizationModule</span>&quot;<span style="color: blue"> </span><span style="color: red">preCondition</span><span style="color: blue">=</span>&quot;<span style="color: blue">managedHandler</span>&quot;<span style="color: blue"> /&gt;</span></p>    <p style="margin: 0px"><span style="color: blue">&#160;&#160;&#160;&#160;&#160;&#160;&#160; &lt;</span><span style="color: #a31515">add</span><span style="color: blue"> </span><span style="color: red">name</span><span style="color: blue">=</span>&quot;<span style="color: blue">AnonymousIdentification</span>&quot;<span style="color: blue"> </span><span style="color: red">type</span><span style="color: blue">=</span>&quot;<span style="color: blue">System.Web.Security.AnonymousIdentificationModule</span>&quot;<span style="color: blue"> </span><span style="color: red">preCondition</span><span style="color: blue">=</span>&quot;<span style="color: blue">managedHandler</span>&quot;<span style="color: blue"> /&gt;</span></p>    <p style="margin: 0px"><span style="color: blue">&#160;&#160;&#160;&#160;&#160;&#160;&#160; &lt;</span><span style="color: #a31515">add</span><span style="color: blue"> </span><span style="color: red">name</span><span style="color: blue">=</span>&quot;<span style="color: blue">Profile</span>&quot;<span style="color: blue"> </span><span style="color: red">type</span><span style="color: blue">=</span>&quot;<span style="color: blue">System.Web.Profile.ProfileModule</span>&quot;<span style="color: blue"> </span><span style="color: red">preCondition</span><span style="color: blue">=</span>&quot;<span style="color: blue">managedHandler</span>&quot;<span style="color: blue"> /&gt;</span></p>    <p style="margin: 0px"><span style="color: blue">&#160;&#160;&#160;&#160;&#160;&#160;&#160; &lt;</span><span style="color: #a31515">add</span><span style="color: blue"> </span><span style="color: red">name</span><span style="color: blue">=</span>&quot;<span style="color: blue">UrlMappingsModule</span>&quot;<span style="color: blue"> </span><span style="color: red">type</span><span style="color: blue">=</span>&quot;<span style="color: blue">System.Web.UrlMappingsModule</span>&quot;<span style="color: blue"> </span><span style="color: red">preCondition</span><span style="color: blue">=</span>&quot;<span style="color: blue">managedHandler</span>&quot;<span style="color: blue"> /&gt;</span></p>    <p style="margin: 0px"><span style="color: blue">&#160;&#160;&#160; &lt;/</span><span style="color: #a31515">modules</span><span style="color: blue">&gt;</span></p>    <p style="margin: 0px"><span style="color: blue">&lt;/</span><span style="color: #a31515">system.webServer</span><span style="color: blue">&gt;</span></p> </div>  <p>(seznam modulů odpovídá verzi runtime 2.0, ve verzi 4.0 jich ještě několik přibylo)</p>  <p>Pokud si napíšete a zaregistrujete vlastní HTTP modul, záleží na vás, zda <code>preCondition=&quot;managedHandler&quot;</code> použijete či nikoliv.</p>  <p>Pokud chcete, aby se konkrétní modul (typicky právě <code>FormsAuthentication</code> a <code>UrlAuthorization</code>) použil, musíte ho ve web.configu své aplikace odregistrovat a zaregistrovat znovu, tentokrát bez <code>preCondition</code>:</p>  <div style="font-family: consolas, &#39;Courier New&#39;, monospace; background: white; color: black; font-size: 13pt">   <p style="margin: 0px"><span style="color: blue">&lt;</span><span style="color: #a31515">system.webServer</span><span style="color: blue">&gt;</span></p>    <p style="margin: 0px"><span style="color: blue">&#160;&#160;&#160; &lt;</span><span style="color: #a31515">modules</span><span style="color: blue">&gt;</span></p>    <p style="margin: 0px"><span style="color: blue">&#160;&#160;&#160;&#160;&#160;&#160;&#160; &lt;</span><span style="color: #a31515">remove</span><span style="color: blue"> </span><span style="color: red">name</span><span style="color: blue">=</span>&quot;<span style="color: blue">FormsAuthentication</span>&quot;<span style="color: blue"> /&gt;</span></p>    <p style="margin: 0px"><span style="color: blue">&#160;&#160;&#160;&#160;&#160;&#160;&#160; &lt;</span><span style="color: #a31515">remove</span><span style="color: blue"> </span><span style="color: red">name</span><span style="color: blue">=</span>&quot;<span style="color: blue">UrlAuthorization</span>&quot;<span style="color: blue"> /&gt;</span></p>    <p style="margin: 0px"><span style="color: blue">&#160;&#160;&#160;&#160;&#160;&#160;&#160; &lt;</span><span style="color: #a31515">add</span><span style="color: blue"> </span><span style="color: red">name</span><span style="color: blue">=</span>&quot;<span style="color: blue">FormsAuthentication</span>&quot;<span style="color: blue"> </span><span style="color: red">type</span><span style="color: blue">=</span>&quot;<span style="color: blue">System.Web.Security.FormsAuthenticationModule</span>&quot;<span style="color: blue"> </span><span style="color: blue">/&gt;</span></p>    <p style="margin: 0px"><span style="color: blue">&#160;&#160;&#160;&#160;&#160;&#160;&#160; &lt;</span><span style="color: #a31515">add</span><span style="color: blue"> </span><span style="color: red">name</span><span style="color: blue">=</span>&quot;<span style="color: blue">UrlAuthorization</span>&quot;<span style="color: blue"> </span><span style="color: red">type</span><span style="color: blue">=</span>&quot;<span style="color: blue">System.Web.Security.UrlAuthorizationModule</span>&quot;<span style="color: blue"> </span><span style="color: blue">/&gt;</span></p>    <p style="margin: 0px"><span style="color: blue">&#160;&#160;&#160; &lt;/</span><span style="color: #a31515">modules</span><span style="color: blue">&gt;</span></p>    <p style="margin: 0px"><span style="color: blue">&lt;/</span><span style="color: #a31515">system.webServer</span><span style="color: blue">&gt;</span></p> </div>  <p>Pokud chcete použít všechny takové moduly, má pro vás IIS k dispozici techniku dle mého názoru dosti zvrhlou, override na override. Konfigurační sekce <code>modules</code> totiž oplývá atributem s poetickým názvem <code>runAllManagedModulesForAllRequests</code>. Pokud je nastaven na <code>true</code>, pak se <code>preCondition=&quot;managedHandler&quot;</code> bude ignorovat. Toto nastavení se vám bude hodit zejména v případě, že používáte URL routing v ASP.NET 4.0, neboť i ten je standardně nastaven tak, že se aplikuje jenom v případě managed handleru. U jeho registrace v <code>applicationHost.config</code> vidíte v akci ještě jednu <code>preCondition</code>, a to požadavek na verzi .NET Runtime 4.0:</p>  <div style="font-family: consolas, &#39;Courier New&#39;, monospace; background: white; color: black; font-size: 13pt">   <p style="margin: 0px"><span style="color: blue">&lt;</span><span style="color: #a31515">add</span><span style="color: blue"> </span><span style="color: red">name</span><span style="color: blue">=</span>&quot;<span style="color: blue">UrlRoutingModule-4.0</span>&quot;<span style="color: blue"> </span><span style="color: red">type</span><span style="color: blue">=</span>&quot;<span style="color: blue">System.Web.Routing.UrlRoutingModule</span>&quot;<span style="color: blue"> </span><span style="color: red">preCondition</span><span style="color: blue">=</span>&quot;<span style="color: blue">managedHandler,runtimeVersionv4.0</span>&quot;<span style="color: blue"> /&gt;</span></p> </div>  <p>  <p>  <p>Problematice preConditions jako takových se budu věnovat v samostatném článku.</p>